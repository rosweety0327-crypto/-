<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>è²“å’ªå¤§æˆ°çˆ­ï¼šé—‡é»‘å•Ÿç¤ºéŒ„ - 1001é—œçµ‚æ¥µç‰ˆ</title>
    <style>
        :root { --dark: #050505; --gold: #f1c40f; --win: #27ae60; --glow: #8e44ad; --text: #e0e0e0; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--dark); margin: 0; color: var(--text); overflow: hidden; }
        
        #save-selector { position: fixed; inset: 0; background: radial-gradient(circle, #1a1a1a, #000); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; }
        .save-btn { width: 300px; padding: 25px; font-size: 24px; font-weight: bold; border-radius: 20px; border: 3px solid var(--glow); cursor: pointer; color: white; transition: 0.3s; box-shadow: 0 0 10px rgba(142, 68, 173, 0.3); }
        .save-btn:hover { transform: translateY(-5px); box-shadow: 0 0 30px var(--glow); filter: brightness(1.2); }
        
        .top-bar { height: 65px; background: #111; display: flex; align-items: center; justify-content: space-around; border-bottom: 3px solid var(--gold); font-size: 20px; }
        .nav { display: flex; justify-content: center; background: #222; padding: 12px; gap: 10px; }
        .nav button { padding: 10px 20px; border-radius: 10px; border: none; cursor: pointer; background: #444; color: white; font-weight: bold; transition: 0.2s; }
        .nav button:hover { background: #666; }
        
        .view { display: none; padding: 20px; height: calc(100vh - 180px); overflow-y: auto; }
        .view.active { display: block; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .stage-card { padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #333; background: #1a1a1a; transition: 0.3s; }
        .locked { opacity: 0.3; filter: grayscale(1); }
        .cleared { border-color: var(--win); background: #002200; box-shadow: inset 0 0 10px var(--win); }
        
        .card { background: #fff; color: #000; padding: 12px; border-radius: 15px; text-align: center; border: 3px solid #666; cursor: pointer; transition: 0.2s; }
        .in-team { border-color: #3498db; background: #b3e5fc; box-shadow: 0 0 20px #3498db; }
        .img-box { font-size: 45px; margin-bottom: 5px; }
        .lvl-up-btn { background: var(--gold); border: none; padding: 6px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 8px; font-size: 12px; }
        
        #battle-screen { display: none; position: fixed; inset: 0; background: #000; z-index: 1000; }
        #battle-ui { position: absolute; top: 0; width: 100%; height: 70px; display: flex; justify-content: space-between; align-items: center; padding: 0 30px; background: rgba(0,0,0,0.85); box-sizing: border-box; z-index: 2000; border-bottom: 2px solid #444; }
        #b-money { font-size: 32px; color: #2ecc71; font-weight: bold; }
        #battle-field { position: absolute; bottom: 160px; width: 100%; height: 400px; background: linear-gradient(to bottom, #050505, #1a1a1a); border-bottom: 5px solid #444; overflow: hidden; }
        .base { position: absolute; bottom: 0; width: 160px; height: 280px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: bold; text-align: center; color: white; }
        .deploy-bar { position: absolute; bottom: 0; width: 100%; height: 160px; background: #111; display: flex; align-items: center; gap: 12px; padding: 0 20px; overflow-x: auto; box-sizing: border-box; border-top: 2px solid #333; }
        .deploy-btn { min-width: 95px; height: 130px; background: #eee; color: black; border-radius: 10px; text-align: center; cursor: pointer; position: relative; overflow: hidden; font-weight: bold; font-size: 12px; flex-shrink: 0; }
        .cd-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 0%; background: rgba(0,0,0,0.7); transition: height linear; }
        .unit { position: absolute; bottom: 15px; font-size: 50px; z-index: 5; transition: left 0.1s linear; }
    </style>
</head>
<body>

<div id="save-selector">
    <h1 style="color:var(--gold); font-size: 45px; text-shadow: 0 0 15px var(--glow); margin-bottom: 0;">è²“å’ªå¤§æˆ°çˆ­ï¼šé—‡é»‘å•Ÿç¤ºéŒ„</h1>
    <p style="color:#aaa; letter-spacing: 2px;">â€”â€” ç¬¬ 1001 å€‹é»ƒæ˜ â€”â€”</p>
    <button class="save-btn" style="background:#2980b9;" onclick="loadSave('yoo')">å°å®¥ çš„æ™‚ç©ºå­˜æª”</button>
    <button class="save-btn" style="background:#8e44ad;" onclick="loadSave('fish')">å°é­šå¼Ÿ çš„æ™‚ç©ºå­˜æª”</button>
</div>

<div id="game-main" style="display:none;">
    <div class="top-bar">
        <span id="player-name" style="color:cyan; font-weight:bold;"></span>
        <span>ğŸ’° XP: <span id="ui-xp">0</span></span>
        <span>ğŸ¥« ç½é ­: <span id="ui-can">0</span></span>
    </div>
    <div class="nav">
        <button onclick="setView('stages')">å¢®è½ä¸–ç•Œ (1001)</button>
        <button onclick="setView('team')">é­”åŠ›é€²åŒ– (å‡ç´š)</button>
        <button onclick="setView('gacha')">æ··æ²Œå¬å–š (æŠ½å¡)</button>
    </div>
    <div id="view-stages" class="view active"><div class="grid" id="stage-grid"></div></div>
    <div id="view-team" class="view"><div class="grid" id="team-grid"></div></div>
    <div id="view-gacha" class="view" style="text-align:center;">
        <div style="margin: 50px 0;">
            <button style="font-size:28px; padding:25px 50px; background:var(--gold); border-radius:60px; border:none; cursor:pointer; font-weight:bold; box-shadow: 0 10px 20px rgba(0,0,0,0.5);" onclick="drawCat()">150 ç½é ­å¬å–š</button>
        </div>
        <div id="gacha-result" style="font-size:30px; margin-top:40px; color:var(--gold); text-shadow: 0 0 15px orange;"></div>
    </div>
</div>

<div id="battle-screen">
    <div id="battle-ui">
        <div id="b-money">ğŸ’µ 0</div>
        <div id="s-title" style="color:var(--gold); font-size: 24px;"></div>
        <button onclick="exitBattle()" style="background:#c0392b; color:white; border:none; padding:10px 25px; border-radius:8px; font-weight:bold; cursor:pointer;">æ’¤é€€</button>
    </div>
    <div id="battle-field">
        <div class="base" style="left:0; background:linear-gradient(to top, #1e3c72, #2a5298); border-right: 4px solid #fff;">
            è–åŸŸè¦å¡<br><span id="m-hp" style="font-size:20px; color:#2ecc71;">5000</span>
        </div>
        <div class="base" style="right:0; background:linear-gradient(to top, #000, #434343); border-left: 4px solid #f00;">
            æ·±æ·µé­”çªŸ<br><span id="e-hp" style="font-size:20px; color:#e74c3c;">500</span>
        </div>
    </div>
    <div class="deploy-bar" id="deploy-btns"></div>
</div>

<script>
// --- 40 ä½è§’è‰²ï¼šå¼·åŒ–å·®ç•°æ€§ ---
const ALL_CATS = [
    { id: 1, name: "å¸Œ", emo: "âš”ï¸", cost: 75, range: 60, atk: 15, hp: 400, cd: 2000 },
    { id: 2, name: "ç§‹", emo: "âš¡", cost: 75, range: 60, atk: 15, hp: 400, cd: 2000 },
    { id: 3, name: "å½±æœˆæ®ºæ‰‹", emo: "ğŸ‘¤", cost: 200, range: 70, atk: 60, hp: 350, cd: 3500 },
    { id: 4, name: "çƒˆç„°é­”å°", emo: "ğŸ”¥", cost: 350, range: 300, atk: 90, hp: 450, cd: 6000 },
    { id: 5, name: "é‡é§å·¨åƒ", emo: "ğŸ›¡ï¸", cost: 500, range: 40, atk: 20, hp: 4500, cd: 12000 },
    { id: 6, name: "æ¥µå…‰çµäºº", emo: "ğŸ¹", cost: 400, range: 450, atk: 110, hp: 300, cd: 8000 },
    { id: 7, name: "æ˜Ÿä¹‹è£æ±º", emo: "ğŸŒŸ", cost: 280, range: 150, atk: 55, hp: 1000, cd: 5000 },
    { id: 8, name: "ç‹‚é›·ä¹‹å·”", emo: "â›ˆï¸", cost: 600, range: 220, atk: 180, hp: 1500, cd: 13000 },
    { id: 9, name: "å†¥æ²³æ“ºæ¸¡", emo: "ğŸ›¶", cost: 550, range: 320, atk: 130, hp: 800, cd: 14000 },
    { id: 10, name: "çµ‚ç„‰ä¹‹é¾", emo: "ğŸ‰", cost: 1500, range: 480, atk: 450, hp: 7000, cd: 45000 },
    { id: 11, name: "æµ·æ·µç‹‚é­”", emo: "ğŸ™", cost: 700, range: 90, atk: 95, hp: 4000, cd: 18000 },
    { id: 12, name: "å½±ä¹‹åŠè–", emo: "ğŸ¥·", cost: 220, range: 140, atk: 70, hp: 600, cd: 4500 },
    { id: 13, name: "è¬å¹´å†°å°", emo: "â„ï¸", cost: 320, range: 180, atk: 60, hp: 1300, cd: 7000 },
    { id: 14, name: "å­¤å‚²æ®˜ç‹¼", emo: "ğŸº", cost: 250, range: 80, atk: 80, hp: 900, cd: 4800 },
    { id: 15, name: "æ™‚ç©ºå›šå¾’", emo: "â³", cost: 650, range: 350, atk: 140, hp: 1000, cd: 16000 },
    { id: 16, name: "æ®²æ»…éµé¨", emo: "ğŸ¤–", cost: 900, range: 250, atk: 250, hp: 3000, cd: 25000 },
    { id: 17, name: "å¢®è½ç¦éŸ³", emo: "ğŸ–¤", cost: 800, range: 420, atk: 190, hp: 1200, cd: 20000 },
    { id: 18, name: "ç„æ·µæƒ¡çŠ¬", emo: "ğŸ•", cost: 100, range: 50, atk: 40, hp: 500, cd: 2800 },
    { id: 19, name: "å¤æ¨¹ç¥æœ¨", emo: "ğŸŒ³", cost: 400, range: 50, atk: 30, hp: 2800, cd: 11000 },
    { id: 20, name: "æ°¸æ†é»‘æ´", emo: "ğŸ•³ï¸", cost: 1800, range: 550, atk: 650, hp: 1500, cd: 55000 },
    { id: 21, name: "è–é¨å£«å°å®¥", emo: "ğŸ‘‘", cost: 1200, range: 330, atk: 320, hp: 7500, cd: 35000 },
    { id: 22, name: "æš—å¤œä¼¯çˆµ", emo: "ğŸ§›", cost: 550, range: 130, atk: 120, hp: 1400, cd: 13000 },
    { id: 23, name: "æ·±æ·µä¹‹çœ¼", emo: "ğŸ‘ï¸", cost: 450, range: 380, atk: 100, hp: 500, cd: 10000 },
    { id: 24, name: "ä¸æ»…æ­¦é­‚", emo: "ğŸ£", cost: 180, range: 70, atk: 55, hp: 800, cd: 3800 },
    { id: 25, name: "é­‚ç´¢é®åˆ€", emo: "ğŸ’€", cost: 1000, range: 260, atk: 280, hp: 2000, cd: 28000 },
    { id: 26, name: "è™›ç©ºé£›è‰‡", emo: "ğŸ›¸", cost: 750, range: 430, atk: 170, hp: 1100, cd: 18000 },
    { id: 27, name: "å¹»é›·éˆç‹", emo: "ğŸ¦Š", cost: 280, range: 160, atk: 75, hp: 700, cd: 5800 },
    { id: 28, name: "å²©æ¼¿ç„šè€…", emo: "ğŸŒ‹", cost: 850, range: 90, atk: 130, hp: 5000, cd: 20000 },
    { id: 29, name: "å’’ç¦æ³•å¸«", emo: "ğŸ”®", cost: 480, range: 310, atk: 105, hp: 600, cd: 11000 },
    { id: 30, name: "è–æ½”ä¹‹ç¿¼", emo: "ğŸ¦…", cost: 650, range: 340, atk: 150, hp: 950, cd: 15000 },
    { id: 31, name: "è’æ¼ å·¨è ", emo: "ğŸ¦‚", cost: 230, range: 80, atk: 65, hp: 850, cd: 4800 },
    { id: 32, name: "æ½®æ±æ­Œè€…", emo: "ğŸ§œ", cost: 350, range: 220, atk: 70, hp: 1500, cd: 8500 },
    { id: 33, name: "å›é€†é¨å£«", emo: "â™Ÿï¸", cost: 300, range: 70, atk: 75, hp: 1200, cd: 5500 },
    { id: 34, name: "æ”¶é­‚å¹½é­‚", emo: "ğŸ‘»", cost: 450, range: 270, atk: 130, hp: 400, cd: 12000 },
    { id: 35, name: "æ¥µå¯’åœ°å¸¶", emo: "ğŸ§Š", cost: 520, range: 200, atk: 90, hp: 1800, cd: 13000 },
    { id: 36, name: "é‘½çŸ³æ„å¿—", emo: "ğŸ’", cost: 1300, range: 180, atk: 180, hp: 11000, cd: 38000 },
    { id: 37, name: "é–ƒçˆè¿…é›·", emo: "âš¡", cost: 260, range: 130, atk: 85, hp: 600, cd: 4500 },
    { id: 38, name: "é‚ªåŸŸä¹‹ä¸»", emo: "ğŸ‘¾", cost: 1600, range: 510, atk: 500, hp: 3000, cd: 48000 },
    { id: 39, name: "çœŸç†è–è³¢", emo: "ğŸ§™", cost: 950, range: 450, atk: 250, hp: 1000, cd: 26000 },
    { id: 40, name: "å‰µä¸–ä¹‹ç¥", emo: "âœ¨", cost: 3000, range: 600, atk: 1500, hp: 15000, cd: 75000 }
];

let userData = { xp: 0, can: 500, owned: [1, 2], team: [1, 2], cleared: [], levels: {}, version: 20260205 };
let currentSlot = '', isFighting = false, bMoney = 0, mHP = 5000, eHP = 500, curS = 0, units = [];

function loadSave(slot) {
    currentSlot = 'CAT_WAR_V1001_' + slot;
    let saved = localStorage.getItem(currentSlot);
    if (saved) {
        let parsed = JSON.parse(saved);
        // æ•¸æ“šè£œå…¨æ©Ÿåˆ¶ï¼šå¦‚æœå­˜æª”è£¡æ²’æœ‰æŸäº›æ¬„ä½ï¼Œå°±è£œä¸Šé è¨­å€¼ï¼Œé€™å°±æ˜¯ä½ è¦çš„ã€Œæ›´æ–°ä¸åˆ·æ‰ç´€éŒ„ã€æŒ‰éµ
        userData = Object.assign({}, userData, parsed);
        userData.version = 20260205; 
    }
    document.getElementById("player-name").innerText = slot==='yoo'?'å°å®¥':'å°é­šå¼Ÿ';
    document.getElementById("save-selector").style.display = "none";
    document.getElementById("game-main").style.display = "block";
    render();
}

function render() {
    document.getElementById("ui-xp").innerText = userData.xp;
    document.getElementById("ui-can").innerText = userData.can;
    
    let stageGrid = document.getElementById("stage-grid");
    stageGrid.innerHTML = "";
    // æ¸²æŸ“ 1001 é—œ
    for(let i=1; i<=1001; i++) {
        let isDone = userData.cleared.includes(i);
        let isLock = i > 1 && !userData.cleared.includes(i-1);
        stageGrid.innerHTML += `
            <div class="stage-card ${isLock?'locked':''} ${isDone?'cleared':''}">
                <b>ç¬¬ ${i} é—œ</b><br>
                ${isLock?'ğŸ”’':`<button style="margin-top:8px;" onclick="startBattle(${i})">ä¾µç•¥</button>`}
            </div>`;
    }

    document.getElementById("team-grid").innerHTML = userData.owned.map(id => {
        const cat = ALL_CATS.find(c => c.id == id);
        let lv = userData.levels[id] || 1;
        let inT = userData.team.includes(id);
        return `<div class="card ${inT?'in-team':''}" onclick="toggleTeam(${id})">
            <div class="img-box">${cat.emo}</div>
            <div style="font-size:13px; font-weight:bold;">${cat.name}</div>
            <div style="font-size:11px;">ç­‰ç´š: ${lv}</div>
            <button class="lvl-up-btn" onclick="event.stopPropagation(); upgradeCat(${id})">å‡ç´š:${lv*1200}XP</button>
        </div>`;
    }).join('');
    localStorage.setItem(currentSlot, JSON.stringify(userData));
}

function upgradeCat(id) {
    let lv = userData.levels[id] || 1;
    if (userData.xp >= lv * 1200) {
        userData.xp -= lv * 1200;
        userData.levels[id] = lv + 1;
        render();
    }
}

function toggleTeam(id) {
    let idx = userData.team.indexOf(id);
    if(idx > -1) { if(userData.team.length > 1) userData.team.splice(idx,1); }
    else { if(userData.team.length < 10) userData.team.push(id); }
    render();
}

function startBattle(id) {
    curS = id;
    isFighting = true;
    bMoney = 0;
    mHP = 5000 + (id * 200); 
    eHP = 3000 + (id * 4000); 
    units = [];
    document.getElementById("s-title").innerText = `ç¬¬ ${id} ç¯€ æˆ°å½¹`;
    document.getElementById("battle-screen").style.display = "block";
    document.getElementById("deploy-btns").innerHTML = userData.team.map(cid => {
        const cat = ALL_CATS.find(c => c.id == cid);
        return `<div id="btn-${cid}" class="deploy-btn" onclick="spawnUnit(${cid})"><div class="cd-overlay" id="cd-${cid}"></div><div style="font-size:40px;margin-top:15px;">${cat.emo}</div>$${cat.cost}</div>`;
    }).join('');
    gameLoop();
}

function spawnUnit(id) {
    const cat = ALL_CATS.find(c => c.id == id);
    const btn = document.getElementById(`btn-${id}`);
    if(cat && bMoney >= cat.cost && !btn.classList.contains('cd')) {
        bMoney -= cat.cost;
        let lv = userData.levels[id] || 1;
        const el = document.createElement("div"); el.className = "unit"; el.innerText = cat.emo;
        document.getElementById("battle-field").appendChild(el);
        units.push({ x: 160, type: 'my', el: el, range: cat.range, atk: cat.atk * (1+lv*0.2), hp: cat.hp * (1+lv*0.2), dead: false });
        btn.classList.add('cd');
        let cdBar = document.getElementById(`cd-${id}`);
        cdBar.style.height = "100%";
        setTimeout(()=>cdBar.style.height="0%", 10);
        cdBar.style.transition = `height ${cat.cd}ms linear`;
        setTimeout(()=>btn.classList.remove('cd'), cat.cd);
    }
}

function gameLoop() {
    if(!isFighting) return;
    bMoney += (3 + curS*0.1); 
    document.getElementById("b-money").innerText = "ğŸ’µ " + Math.floor(bMoney);
    document.getElementById("m-hp").innerText = Math.round(mHP);
    document.getElementById("e-hp").innerText = Math.round(eHP);

    units.forEach(u => {
        if(u.dead) return;
        let r = u.type==='my'?u.range:55;
        let target = units.find(t => !t.dead && t.type !== u.type && Math.abs(t.x - u.x) < r);
        let baseInRange = (u.type==='my' && (window.innerWidth-160-u.x)<r) || (u.type==='en' && (u.x-160)<55);
        
        if(target || baseInRange) {
            if(u.type==='my') { if(target) target.hp-=u.atk; else eHP-=u.atk; }
            else { if(target) target.hp-=(20+curS*5); else mHP-=(25+curS*10); }
            if(target && target.hp<=0) { target.dead=true; target.el.remove(); }
        } else {
            if(u.type==='my') { u.x+=4; u.el.style.left=u.x+"px"; }
            else { u.x-=2.5; u.el.style.left=u.x+"px"; }
        }
    });
    units = units.filter(u => !u.dead);

    if(Math.random() < 0.02 + (curS*0.001)) {
        const el = document.createElement("div"); el.className = "unit"; el.innerText = "ğŸ‘¾";
        document.getElementById("battle-field").appendChild(el);
        units.push({ x: window.innerWidth-160, type:'en', el:el, hp:200*(1+curS*1.2), dead:false });
    }

    if(eHP<=0) { 
        let rewardCan = 10 + Math.floor(curS * 2);
        alert(`å‹åˆ©ï¼\nç²å¾— XP: ${curS*1000}\nç²å¾— ç½é ­: ${rewardCan}`); 
        userData.xp += curS*1000;
        userData.can += rewardCan;
        if(!userData.cleared.includes(curS)) userData.cleared.push(curS);
        exitBattle();
    }
    if(mHP<=0) { alert("å¤±æ•—..."); exitBattle(); }
    if(isFighting) requestAnimationFrame(gameLoop);
}

function exitBattle() { 
    isFighting = false; 
    document.getElementById("battle-screen").style.display = "none"; 
    document.querySelectorAll('.unit').forEach(u => u.remove());
    render(); 
}

function drawCat() {
    if(userData.can < 150) { alert("ç½é ­ä¸è¶³ï¼"); return; }
    userData.can -= 150;
    // æŠ½çé‚è¼¯ï¼šå¾æœªæ“æœ‰çš„æ± å­è£¡æŠ½
    let pool = ALL_CATS.filter(c => !userData.owned.includes(c.id));
    if(pool.length > 0) { 
        let win = pool[Math.floor(Math.random()*pool.length)]; 
        userData.owned.push(win.id); 
        document.getElementById("gacha-result").innerText = "æ­å–œç²å¾—ï¼šã€" + win.name + "ã€‘";
    } else { document.getElementById("gacha-result").innerText = "å·²æ“æœ‰æ‰€æœ‰è§’è‰²ï¼"; }
    render();
}

function setView(v) { 
    document.querySelectorAll('.view').forEach(e=>e.classList.remove('active')); 
    document.getElementById('view-'+v).classList.add('active'); 
}
</script>
</body>
</html>
