<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼šçœŸäººæ…¢æ´»ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 250px; background: #000; padding: 12px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 2px solid #3498db; margin-top: 20px; }
        #board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 800px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 10px; text-align: center; border-radius: 10px; font-size: 12px; position: relative; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; }
        .card.teammate { border: 2px solid #e53935; }
        .btn-act { padding: 5px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 5px; width: 100%; font-size: 11px; font-weight: bold; }
        .main-btn { padding: 12px 40px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 10px; }
        .chat-ui { width: 95%; max-width: 650px; display: flex; gap: 5px; margin-bottom: 15px; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #37474f; background: #1c2732; color: white; }
        #timer { font-size: 24px; color: #ff5252; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>

    <h2>ğŸº ç‹¼äººæ®ºï¼šçœŸäººæˆ°è¡“å¼·åŒ–ç‰ˆ</h2>
    <div id="timer">å€’æ•¸ï¼š--</div>
    <div id="status" style="color:#ffa000; margin-bottom:10px;">ä¼ºæœå™¨å°±ç·’ (ID: <span id="my-id">...</span>)</div>

    <div id="setup-ui" class="setup-box">
        <input type="text" id="join-id" placeholder="è¼¸å…¥ ID" style="padding:10px; width: 120px; text-align: center;">
        <button onclick="connectToFriend()">é€£ç·šæœ‹å‹</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display">ç­‰å¾…é–‹å§‹...</h3>
        <div id="log">>> ç³»çµ±ï¼šæº–å‚™å°±ç·’ã€‚</div>
        <div class="chat-ui">
            <input type="text" id="chat-input" placeholder="ç‹¼äººè«‹åœ¨æ­¤è¨è«–ç›®æ¨™..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">å‚³é€</button>
        </div>
        <div id="board"></div>
        <button id="next-btn" class="main-btn" style="display:none;" onclick="hostCycle()">é–‹å§‹éŠæˆ²</button>
        <button id="skip-night-btn" class="main-btn" style="display:none; background:#d32f2f;" onclick="checkNightEnd(true)">ææ—©å¤©äº®</button>
    </div>

<script>
    const shortId = Math.floor(1000 + Math.random() * 9000).toString();
    const peer = new Peer(shortId);
    let conn;
    let isHost = false;
    let myName = "";
    let timeLeft = 0;
    let timerInterval;

    let game = { 
        players: [], phase: "WAITING", logs: [],
        nightActions: { wolf: false, seer: false, witch: false, victim: null, poison: null, saved: false, seerTargetIdx: -1, seerResultIsWolf: false, seerIsAI: false },
        votes: {},
        countdown: 0
    };

    peer.on('open', id => { document.getElementById('my-id').innerText = id; });
    peer.on('connection', incoming => { conn = incoming; isHost = true; myName = "æˆ¿ä¸»(A)"; document.getElementById('next-btn').style.display = "inline-block"; setupDataListener(); initUI(); });
    function connectToFriend() { const id = document.getElementById('join-id').value; conn = peer.connect(id); isHost = false; myName = "æœ‹å‹(B)"; setupDataListener(); initUI(); }
    function initUI() { document.getElementById('setup-ui').style.display = "none"; document.getElementById('game-ui').style.display = "block"; }

    function setupDataListener() {
        conn.on('data', data => {
            if (data.type === "CHAT") addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`);
            else if (data.type === "CHECK_RESULT") { alert(data.msg); addLog(`ğŸ”® ç§è¨Šï¼š${data.msg}`); }
            else if (isHost && data.type === "ACTION") handleAction(data.target, data.fromIdx, data.subType);
            else if (!isHost) { game = data; updateUI(); }
        });
    }

    function sendChat(sender = myName, message = null) {
        const input = document.getElementById('chat-input');
        const msg = message || input.value.trim();
        if (!msg) return;
        addLog(`ğŸ’¬ ${sender}: ${msg}`);
        if (conn) conn.send({ type: "CHAT", sender: sender, msg: msg });
        if (!message) input.value = "";
    }

    function startTimer(seconds) {
        clearInterval(timerInterval);
        timeLeft = seconds;
        document.getElementById('timer').innerText = `å€’æ•¸ï¼š${timeLeft}`;
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = `å€’æ•¸ï¼š${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (isHost && game.phase === "NIGHT") checkNightEnd(true); // æ™‚é–“åˆ°å¼·åˆ¶å¤©äº®
            }
        }, 1000);
    }

    async function hostCycle() {
        if (!isHost || game.gameOver) return;
        if (game.phase === "WAITING") {
            const roles = ["ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘"].sort(() => Math.random() - 0.5);
            game.players = roles.map((r, i) => ({ id: i, name: i===0?"æˆ¿ä¸»(A)":(i===1?"æœ‹å‹(B)":`AI-${i+1}`), role: r, isAlive: true, isAI: i>=2 }));
            startNight();
        } else if (game.phase === "MORNING") {
            if (game.nightActions.seerIsAI && game.nightActions.seerTargetIdx !== -1) {
                const target = game.players[game.nightActions.seerTargetIdx];
                setTimeout(() => sendChat("AI é è¨€å®¶", `æˆ‘æ˜¯é è¨€å®¶ï¼Œé©—äº† ${target.name} æ˜¯ ${game.nightActions.seerResultIsWolf?'ç‹¼äºº':'å¥½äºº'}ï¼`), 1000);
            }
            game.phase = "VOTE"; 
            game.votes = {};
            addLog("âš–ï¸ é€²å…¥æŠ•ç¥¨éšæ®µ (30ç§’è¨è«–)");
            startTimer(30);
            setTimeout(() => aiVoteLogic(), 10000); // AI ç­‰ 10 ç§’å†æŠ•
        } else if (game.phase === "VOTE_DONE") { startNight(); }
        sync();
    }

    function startNight() {
        game.phase = "NIGHT";
        game.nightActions = { wolf: false, seer: false, witch: false, victim: null, poison: null, saved: false, seerTargetIdx: -1, seerResultIsWolf: false, seerIsAI: false };
        addLog("ğŸŒ™ å¤©é»‘è«‹é–‰çœ¼ (30ç§’è¨è«–èˆ‡è¡Œå‹•)");
        startTimer(30);
        sync();
        
        // AI å»¶é²è¡Œå‹•ï¼šä¸ç§’æ®ºï¼Œç­‰åˆ°å‰©ä¸‹ 10 ç§’å·¦å³æ‰è¡Œå‹•
        setTimeout(() => {
            if (game.phase !== "NIGHT") return;
            const aiSeer = game.players.find(p => p.isAI && p.isAlive && p.role === "é è¨€å®¶");
            if (aiSeer && !game.nightActions.seer) handleAction(game.players.filter(p=>p.isAlive && p.id!==aiSeer.id)[0].id, aiSeer.id, "CHECK");
        }, 5000);

        setTimeout(() => {
            if (game.phase !== "NIGHT") return;
            const aiWolf = game.players.filter(p => p.role === "ç‹¼äºº" && p.isAlive && p.isAI);
            if (aiWolf.length > 0 && !game.nightActions.wolf) {
                const targets = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº");
                handleAction(targets[Math.floor(Math.random() * targets.length)].id, aiWolf[0].id, "KILL");
            }
        }, 15000); // AI ç‹¼äºº 15 ç§’å¾Œæ‰å‹•æ‰‹
    }

    function handleAction(targetIdx, fromIdx, subType) {
        if (!isHost) return;
        if (subType === "VOTE") {
            game.votes[fromIdx] = targetIdx;
            addLog(`âœ… ${game.players[fromIdx].name} å·²æŠ•ç¥¨ã€‚`);
            checkVoteEnd();
        } 
        else if (subType === "CHECK") {
            game.nightActions.seer = true;
            game.nightActions.seerIsAI = game.players[fromIdx].isAI;
            game.nightActions.seerTargetIdx = targetIdx;
            game.nightActions.seerResultIsWolf = (game.players[targetIdx].role === "ç‹¼äºº");
            if (fromIdx === 0) alert(`æŸ¥é©—çµæœï¼š${game.players[targetIdx].name} æ˜¯ ${game.players[targetIdx].role}`);
            else if (fromIdx === 1) conn.send({ type: "CHECK_RESULT", msg: `æŸ¥é©—çµæœï¼š${game.players[targetIdx].name} æ˜¯ ${game.players[targetIdx].role}` });
        }
        else if (subType === "KILL") { game.nightActions.victim = targetIdx; game.nightActions.wolf = true; addLog("ğŸº ç‹¼äººå·²é¸å®šç›®æ¨™ã€‚"); }
        else if (subType === "WITCH_SAVE") { game.nightActions.saved = true; game.nightActions.witch = true; }
        else if (subType === "WITCH_POISON") { game.nightActions.poison = targetIdx; game.nightActions.witch = true; }
        else if (subType === "WITCH_PASS") { game.nightActions.witch = true; }
        else if (subType === "HUNTER_SHOT") { processDeath(targetIdx, "çµäººé–‹æ§"); }

        sync();
    }

    function checkNightEnd(force = false) {
        if (!isHost) return;
        const alive = (r) => game.players.some(p => p.role === r && p.isAlive);
        const allActed = (!alive("ç‹¼äºº") || game.nightActions.wolf) && (!alive("é è¨€å®¶") || game.nightActions.seer) && (!alive("å¥³å·«") || game.nightActions.witch);
        
        if (allActed || force) {
            clearInterval(timerInterval);
            if (game.nightActions.victim !== null && !game.nightActions.saved) processDeath(game.nightActions.victim, "ç‹¼äººçµæ®º");
            if (game.nightActions.poison !== null) processDeath(game.nightActions.poison, "å¥³å·«æ¯’æ®º");
            game.phase = "MORNING";
            addLog("â˜€ï¸ å¤©äº®äº†ï¼");
            setTimeout(() => hostCycle(), 3000);
            sync();
        }
    }

    function aiVoteLogic() {
        if (!isHost || game.phase !== "VOTE") return;
        game.players.forEach(p => {
            if (p.isAI && p.isAlive && game.votes[p.id] === undefined) {
                let targetIdx;
                if (game.nightActions.seerResultIsWolf && game.players[game.nightActions.seerTargetIdx].isAlive) {
                    targetIdx = game.nightActions.seerTargetIdx;
                } else {
                    const others = game.players.filter(ap => ap.isAlive && ap.id !== p.id);
                    targetIdx = others[Math.floor(Math.random() * others.length)].id;
                }
                game.votes[p.id] = targetIdx;
                sendChat(p.name, `æˆ‘æŠ•ç¥¨çµ¦ç©å®¶ ${targetIdx + 1}`);
            }
        });
        checkVoteEnd();
    }

    function checkVoteEnd() {
        const aliveCount = game.players.filter(p => p.isAlive).length;
        if (Object.keys(game.votes).length >= aliveCount) {
            clearInterval(timerInterval);
            const tally = {};
            Object.values(game.votes).forEach(vid => tally[vid] = (tally[vid] || 0) + 1);
            let max = 0, loser = -1;
            for (let pid in tally) { if (tally[pid] > max) { max = tally[pid]; loser = pid; } }
            addLog(`ğŸ—³ï¸ æŠ•ç¥¨çµæŸï¼Œç©å®¶ ${parseInt(loser)+1} æœ€é«˜ç¥¨æ·˜æ±°ã€‚`);
            processDeath(loser, "æŠ•ç¥¨æ”¾é€");
            game.phase = "VOTE_DONE";
            sync();
        }
    }

    function processDeath(idx, reason) {
        const p = game.players[idx];
        if (!p || !p.isAlive) return;
        p.isAlive = false;
        addLog(`ğŸ’€ ${p.name} æ­»äº¡ (${reason})`);
        if (p.role === "çµäºº") {
            addLog(`ğŸ”« çµäºº ${p.name} æŠ€èƒ½å•Ÿå‹•ï¼`);
            if (p.isAI) {
                const targets = game.players.filter(tp => tp.isAlive);
                if (targets.length > 0) handleAction(targets[0].id, p.id, "HUNTER_SHOT");
            }
        }
        checkWin();
    }

    function checkWin() {
        const w = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const h = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if (w === 0) { alert("ğŸ‰ å¥½äººå‹åˆ©ï¼"); location.reload(); }
        else if (w >= h) { alert("ğŸº ç‹¼äººå‹åˆ©ï¼"); location.reload(); }
    }

    function sync() { 
        if (isHost && conn) { 
            game.countdown = timeLeft;
            conn.send(game); 
            updateUI(); 
        } 
    }

    function updateUI() {
        const myIdx = isHost ? 0 : 1; const me = game.players[myIdx]; if (!me) return;
        document.getElementById('timer').innerText = `å€’æ•¸ï¼š${game.countdown || timeLeft}`;
        document.getElementById('role-display').innerText = `æˆ‘çš„èº«ä»½ï¼šã€${me.role}ã€‘ (${me.isAlive ? 'å­˜æ´»' : 'æ­»äº¡'})`;
        document.getElementById('skip-night-btn').style.display = (isHost && game.phase === "NIGHT") ? "inline-block" : "none";
        
        const board = document.getElementById('board'); board.innerHTML = "";
        game.players.forEach((p, i) => {
            const div = document.createElement('div');
            const isWolfTeammate = (me.role === "ç‹¼äºº" && p.role === "ç‹¼äºº" && i !== myIdx);
            div.className = `card ${p.isAlive ? '' : 'dead'} ${i === myIdx ? 'my-card' : ''} ${isWolfTeammate ? 'teammate' : ''}`;
            const canSee = (i === myIdx || !p.isAlive || isWolfTeammate);
            div.innerHTML = `<b>${p.name}</b><br><small>${canSee ? p.role : '???'}</small>`;

            if (p.isAlive) {
                if (game.phase === "VOTE" && me.isAlive && game.votes[myIdx] === undefined && i !== myIdx) 
                    div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, ${myIdx}, 'VOTE')">æŠ•ç¥¨</button>`;
                if (game.phase === "NIGHT" && me.isAlive) {
                    if (me.role === "ç‹¼äºº" && !game.nightActions.wolf) div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, ${myIdx}, 'KILL')">æ“Šæ®º</button>`;
                    if (me.role === "é è¨€å®¶" && !game.nightActions.seer) div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, ${myIdx}, 'CHECK')">é©—äºº</button>`;
                    if (me.role === "å¥³å·«" && !game.nightActions.witch) {
                        if (i === game.nightActions.victim) div.innerHTML += `<button class="btn-act" style="background:#43a047" onclick="userClick(${i}, ${myIdx}, 'WITCH_SAVE')">æ•‘äºº</button>`;
                        div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, ${myIdx}, 'WITCH_POISON')">æŠ•æ¯’</button>`;
                    }
                }
            }
            board.appendChild(div);
        });
        const l = document.getElementById('log'); l.innerHTML = game.logs.join('<br>'); l.scrollTop = l.scrollHeight;
    }

    function userClick(idx, myIdx, type) { if (isHost) handleAction(idx, myIdx, type); else conn.send({ type: "ACTION", target: idx, fromIdx: myIdx, subType: type }); }
    function addLog(m) { if (isHost) game.logs.push(`> ${m}`); }
</script>
</body>
</html>