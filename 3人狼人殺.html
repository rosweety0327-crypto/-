<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å¤šäººç‹¼äººæ®ºï¼šé ˜ä¸»éš±è—èº«åˆ†ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; text-align: center; padding: 10px; }
        .box { background: #1c2732; padding: 15px; border-radius: 12px; border: 2px solid #3498db; max-width: 400px; margin: 10px auto; }
        #board { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        .card { background: #263238; border: 2px solid #455a64; padding: 10px; border-radius: 10px; min-height: 80px; }
        .card.my-card { border-color: #f1c40f; box-shadow: 0 0 10px #f1c40f; } /* è‡ªå·±çš„å¡ç‰‡ç™¼é»ƒå…‰ */
        .role-text { font-weight: bold; font-size: 18px; margin-top: 5px; display: block; }
        .btn-start { background: #e74c3c; color: white; padding: 15px; font-size: 20px; width: 80%; border: none; border-radius: 10px; cursor: pointer; display: none; margin: 10px auto; }
        input { padding: 10px; border-radius: 5px; border: none; width: 60%; text-align: center; }
    </style>
</head>
<body>

    <h2 style="color:#3498db">ğŸº å¤šäººç‹¼äººæ®ºï¼šé ˜ä¸»åŸºåœ°</h2>

    <div id="setup-area">
        <div class="box">
            <p>æˆ¿è™Ÿ (Room ID): <input id="room-id" placeholder="ä¾‹å¦‚: 777"></p>
            <button onclick="init(true)" style="background:#27ae60; color:white; padding:8px 15px; border-radius:5px;">ç•¶æˆ¿ä¸»</button>
            <button onclick="init(false)" style="background:#2980b9; color:white; padding:8px 15px; border-radius:5px;">é€²æˆ¿é–“</button>
            <p id="status" style="color:yellow; font-size:12px;">è¼¸å…¥æˆ¿è™Ÿä¸¦é¸æ“‡èº«åˆ†</p>
        </div>
        <button id="start-btn" class="btn-start" onclick="startGame()">âš”ï¸ ç«‹åˆ»é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="board"></div>

    <script>
        let peer = null, conns = [], isHost = false, myIdx = -1;
        let game = { players: [], phase: "WAITING" };

        function init(asHost) {
            const id = document.getElementById('room-id').value;
            if(!id) return alert("è«‹è¼¸å…¥æˆ¿è™Ÿï¼");
            isHost = asHost;
            
            // æˆ¿ä¸» ID å›ºå®šç‚º poki-IDï¼ŒéšŠå‹éš¨æ©Ÿ ID
            peer = isHost ? new Peer('poki-' + id) : new Peer();
            
            peer.on('open', () => {
                if(isHost) {
                    document.getElementById('status').innerText = "âœ… æˆ¿è™Ÿ poki-" + id + " ç­‰å¾…ä¸­...";
                    document.getElementById('start-btn').style.display = 'block';
                } else {
                    let c = peer.connect('poki-' + id);
                    setupConn(c);
                    document.getElementById('status').innerText = "æ­£åœ¨é€£å…¥ poki-" + id + "...";
                }
            });

            peer.on('connection', c => {
                setupConn(c);
                alert("æœ‰ç©å®¶é€²å ´äº†ï¼");
            });
        }

        function setupConn(c) {
            conns.push(c);
            c.on('data', data => {
                if(data.type === "SYNC") {
                    game = data.game;
                    myIdx = data.targetIdx; // æˆ¿ä¸»å‘Šè¨´æˆ‘æ˜¯ç¬¬å¹¾è™Ÿç©å®¶
                    render();
                }
            });
        }

        function startGame() {
            const roles = ["ç‹¼äºº", "é è¨€å®¶", "å¹³æ°‘", "å¥³å·«", "å¹³æ°‘", "å¹³æ°‘"]; // é è¨­è§’è‰²
            game.players = [];
            
            // 1. åŠ å…¥æˆ¿ä¸» (æˆ‘)
            game.players.push({ name: "å°å®¥é ˜ä¸»", role: roles[0], isAlive: true });
            
            // 2. åŠ å…¥é€£ç·šç©å®¶
            conns.forEach((c, i) => {
                game.players.push({ name: "ç©å®¶ " + (i+2), role: roles[(i+1)%roles.length], isAlive: true });
            });

            // 3. è£œ AI åˆ° 6 äºº
            while(game.players.length < 6) {
                game.players.push({ name: "AI è²“å¥´ " + (game.players.length+1), role: "å¹³æ°‘", isAlive: true });
            }

            game.phase = "START";
            
            // 4. ç™¼é€è³‡æ–™çµ¦æ‰€æœ‰äººï¼Œä¸¦å‘Šè¨´ä»–å€‘æ˜¯èª°
            conns.forEach((c, i) => {
                c.send({ type: "SYNC", game: game, targetIdx: i + 1 });
            });
            
            myIdx = 0; // æˆ¿ä¸»æ°¸é æ˜¯ 0
            render();
        }

        function render() {
            document.getElementById('setup-area').style.display = 'none';
            const board = document.getElementById('board');
            board.innerHTML = "";

            game.players.forEach((p, i) => {
                const isMe = (i === myIdx);
                const div = document.createElement('div');
                div.className = `card ${isMe ? 'my-card' : ''}`;
                
                // æ ¸å¿ƒé‚è¼¯ï¼šå¦‚æœæ˜¯è‡ªå·±ï¼Œé¡¯ç¤ºèº«åˆ†ï¼›å¦‚æœæ˜¯åˆ¥äººï¼Œéš±è—ï¼
                let roleDisplay = (isMe || !p.isAlive) ? p.role : "???";
                let color = (isMe) ? "#f1c40f" : "#fff";

                div.innerHTML = `
                    <small>${isMe ? 'ã€ä½ ã€‘' : 'ç©å®¶ '+(i+1)}</small><br>
                    <b>${p.name}</b><br>
                    <span class="role-text" style="color:${color}">${roleDisplay}</span>
                `;
                board.appendChild(div);
            });
        }
    </script>
</body>
</html>
