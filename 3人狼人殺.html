<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼šé ˜ä¸»å…¨èƒ½ 12 äººç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 180px; background: #000; padding: 12px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 2px solid #3498db; margin-top: 20px; }
        #board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 800px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 10px; text-align: center; border-radius: 10px; font-size: 12px; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; }
        .btn-act { padding: 5px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 5px; width: 100%; font-size: 11px; font-weight: bold; }
        .chat-ui { width: 95%; max-width: 650px; display: flex; gap: 5px; margin-bottom: 10px; }
        #chat-input { flex-grow: 1; padding: 8px; border-radius: 5px; border: 1px solid #37474f; background: #1c2732; color: white; }
        .main-btn { padding: 12px 30px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <h2>ğŸº 12äººå…¨è·èƒ½é€²åŒ–ç‰ˆ (AI+ç™¼è¨€)</h2>
    <div id="status" style="color:#ffa000; margin-bottom:10px;">ID: <span id="my-id">...</span></div>

    <div id="setup-ui" class="setup-box">
        <button class="main-btn" onclick="hostStart()">æˆ¿ä¸»ï¼šé–‹å±€ (è‡ªå‹•è£œ12äºº)</button>
        <hr style="border:0.5px solid #333; margin:15px 0;">
        <input type="text" id="join-id" placeholder="è¼¸å…¥ ID" style="padding:10px; width:120px; text-align:center;">
        <button onclick="connectToHost()" style="padding:10px; background:#3498db; color:white; border-radius:5px; border:none; cursor:pointer;">åŠ å…¥</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display" style="color:#fdd835;">è§’è‰²åˆ†é…ä¸­...</h3>
        <div id="log"></div>
        <div class="chat-ui">
            <input type="text" id="chat-input" placeholder="èªªé»ä»€éº¼å§..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" style="padding:8px 15px; background:#2980b9; color:white; border:none; border-radius:5px; cursor:pointer;">å‚³é€</button>
        </div>
        <div id="board"></div>
        <button id="next-btn" class="main-btn" style="display:none; background:#1565c0;" onclick="forceNext()">æˆ¿ä¸»ï¼šä¸‹ä¸€å¤©</button>
    </div>

<script>
    const peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
    let conns = [], myConn, isHost = false, myIdx = -1;
    let game = { players: [], phase: "WAITING", logs: [], victim: null, poison: null, healUsed: false, poisonUsed: false, seerInfo: null };

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { isHost = true; conns.push(c); c.on('data', d => handleData(d)); });

    function connectToHost() {
        myConn = peer.connect(document.getElementById('join-id').value);
        myConn.on('data', d => handleData(d));
        document.getElementById('setup-ui').innerHTML = "<h3>âœ… å·²é€£ç·šï¼Œç­‰å¾…é–‹å±€</h3>";
    }

    function hostStart() {
        isHost = true;
        const roles = ["ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","é¨å£«","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘"].sort(() => Math.random() - 0.5);
        game.players = Array.from({length: 12}, (_, i) => ({
            id: i, name: i === 0 ? "æˆ¿ä¸»(A)" : (i <= conns.length ? `ç©å®¶${i+1}` : `AI-${i+1}`),
            role: roles[i], isAlive: true, isAI: i > conns.length
        }));
        myIdx = 0; game.phase = "NIGHT";
        addLog("ğŸŒ™ éŠæˆ²é–‹å§‹ï¼å¤©é»‘è«‹é–‰çœ¼ã€‚");
        broadcast();
        aiProcess();
    }

    function handleData(data) {
        if(data.type === "SYNC") { game = data.game; myIdx = data.idx; updateUI(); }
        else if(data.type === "CHAT") { addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`); }
        else if(data.type === "ACTION") { processAction(data.target, data.from, data.sub); }
        else if(data.type === "ALERT") { alert(data.msg); }
    }

    function broadcast() { 
        if(!isHost) return; updateUI(); 
        conns.forEach((c, i) => c.send({ type: "SYNC", game: game, idx: i+1 })); 
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim(); if(!msg) return;
        const sender = game.players[myIdx].name;
        addLog(`ğŸ’¬ ${sender}: ${msg}`);
        const chatData = { type: "CHAT", sender, msg };
        if(isHost) conns.forEach(c => c.send(chatData)); else myConn.send(chatData);
        input.value = "";
    }

    function addLog(m) { game.logs.push(`> ${m}`); if(game.logs.length > 12) game.logs.shift(); updateUI(); }

    function updateUI() {
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
        const me = game.players[myIdx];
        document.getElementById('role-display').innerText = `æˆ‘çš„èº«åˆ†ï¼š${me.role} (${me.isAlive?'å­˜æ´»':'æ­»äº¡'})`;
        document.getElementById('log').innerHTML = game.logs.join('<br>');
        
        const board = document.getElementById('board'); board.innerHTML = "";
        game.players.forEach((p, i) => {
            const card = document.createElement('div');
            const canSee = (i===myIdx || !p.isAlive || (me.role==='ç‹¼äºº' && p.role==='ç‹¼äºº'));
            card.className = `card ${p.isAlive?'':'dead'} ${i===myIdx?'my-card':''}`;
            card.innerHTML = `<b>${i+1}.${p.name}</b><br>${canSee?p.role:'???'}`;

            if(p.isAlive && me.isAlive) {
                if(game.phase === "NIGHT") {
                    if(me.role === "ç‹¼äºº" && i!==myIdx) card.innerHTML += `<button class="btn-act" onclick="doAct(${i},'KILL')">æ®º</button>`;
                    if(me.role === "é è¨€å®¶" && i!==myIdx) card.innerHTML += `<button class="btn-act" style="background:#2980b9" onclick="doAct(${i},'CHECK')">é©—</button>`;
                    if(me.role === "å¥³å·«") {
                        if(i === game.victim && !game.healUsed) card.innerHTML += `<button class="btn-act" style="background:#27ae60" onclick="doAct(${i},'HEAL')">æ•‘</button>`;
                        if(i !== myIdx && !game.poisonUsed) card.innerHTML += `<button class="btn-act" style="background:#8e44ad" onclick="doAct(${i},'POISON')">æ¯’</button>`;
                    }
                    if(me.role === "é¨å£«" && i!==myIdx) card.innerHTML += `<button class="btn-act" style="background:#f39c12" onclick="doAct(${i},'KNIGHT')">æ±ºé¬¥</button>`;
                } else if(game.phase === "VOTE" && i!==myIdx) {
                    card.innerHTML += `<button class="btn-act" style="background:#d35400" onclick="doAct(${i},'VOTE')">æŠ•</button>`;
                }
            }
            board.appendChild(card);
        });
        if(isHost) document.getElementById('next-btn').style.display = "inline-block";
    }

    function doAct(t, s) { if(isHost) processAction(t, myIdx, s); else myConn.send({ type: "ACTION", target: t, from: myIdx, sub: s }); }

    function processAction(t, f, s) {
        if(!isHost) return;
        const target = game.players[t];
        if(s === "KILL") { game.victim = t; addLog("ç‹¼äººå·²ç§˜å¯†è¡Œå‹•ã€‚"); }
        else if(s === "CHECK") {
            const res = `${t+1}è™Ÿ æ˜¯ ${target.role==='ç‹¼äºº'?'ç‹¼äºº':'å¥½äºº'}`;
            if(f === 0) alert(res); else conns[f-1].send({ type: "ALERT", msg: res });
            addLog("é è¨€å®¶çœé–‹äº†çœ¼ã€‚");
        }
        else if(s === "HEAL") { game.victim = null; game.healUsed = true; addLog("å¥³å·«ä½¿ç”¨äº†å¥‡è¹Ÿè—¥æ°´ã€‚"); }
        else if(s === "POISON") { target.isAlive = false; game.poisonUsed = true; addLog(`${t+1}è™Ÿ æ¶ˆå¤±åœ¨æ¯’éœ§ä¸­ã€‚`); }
        else if(s === "VOTE") { target.isAlive = false; addLog(`${t+1}è™Ÿ è¢«å…¬æŠ•è™•æ±ºã€‚`); game.phase = "NIGHT"; }
        else if(s === "KNIGHT") {
            if(target.role === "ç‹¼äºº") { target.isAlive = false; addLog(`é¨å£«æ±ºé¬¥å‹åˆ©ï¼ç‹¼äºº ${t+1}è™Ÿ æ­»äº¡ã€‚`); }
            else { game.players[f].isAlive = false; addLog(`é¨å£«æ±ºé¬¥å¤±æ•—ï¼é¨å£« ${f+1}è™Ÿ æ­»äº¡ã€‚`); }
            game.phase = "VOTE";
        }
        broadcast(); checkWin();
    }

    function aiProcess() {
        if(!isHost || game.phase !== "NIGHT") return;
        game.players.forEach(p => {
            if(p.isAlive && p.isAI) {
                if(p.role === "ç‹¼äºº" && game.victim === null) {
                    const targets = game.players.filter(x => x.isAlive && x.role !== "ç‹¼äºº");
                    processAction(targets[Math.floor(Math.random()*targets.length)].id, p.id, "KILL");
                }
                if(p.role === "é è¨€å®¶") {
                    const t = game.players.find(x => x.isAlive && x.id !== p.id);
                    // AI é è¨€å®¶æœƒæŸ¥é©—å¾Œå‡è£ç™¼è¨€
                    setTimeout(() => addLog(`ğŸ’¬ ${p.name}: æˆ‘æŸ¥äº†ï¼ŒæŸäººèº«åˆ†ä¸å–®ç´”å–”...`), 3000);
                }
            }
        });
    }

    function forceNext() {
        if(game.phase === "NIGHT") {
            if(game.victim !== null) { game.players[game.victim].isAlive = false; addLog(`${game.victim+1}è™Ÿ æ˜¨æ™šæ…˜é­æ¯’æ‰‹ã€‚`); }
            else addLog("æ˜¨æ™šæ˜¯å€‹å¹³å®‰å¤œã€‚");
            game.phase = "VOTE";
            game.victim = null;
        } else { game.phase = "NIGHT"; aiProcess(); }
        broadcast();
    }

    function checkWin() {
        const w = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const h = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if(w === 0) { alert("å¥½äººå‹åˆ©ï¼"); location.reload(); }
        else if(w >= h) { alert("ç‹¼äººå‹åˆ©ï¼"); location.reload(); }
    }
</script>
</body>
</html>
