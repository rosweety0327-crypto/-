<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼šé ˜ä¸»å¤šäººç‰ˆ (2-6äºº+AI)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 180px; background: #000; padding: 12px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 3px solid #f1c40f; margin-top: 20px; width: 320px; }
        #board { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; width: 100%; max-width: 800px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 10px; text-align: center; border-radius: 10px; font-size: 12px; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; box-shadow: 0 0 10px #fdd835; }
        .main-btn { padding: 15px 30px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin-top: 15px; font-weight: bold; width: 100%; }
        .join-btn { padding: 10px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #timer { font-size: 24px; color: #ff5252; font-weight: bold; margin-bottom: 5px; }
        select { padding: 10px; font-size: 16px; border-radius: 5px; background: #000; color: white; width: 100%; margin-top: 10px; }
    </style>
</head>
<body>

    <h2>ğŸº ç‹¼äººæ®ºï¼šå¤šäººé€²åŒ–ç‰ˆ</h2>
    <div id="timer">æº–å‚™ä¸­...</div>
    <div id="status" style="color:#ffa000; margin-bottom:10px;">æˆ‘çš„ ID: <span id="my-id">...</span></div>

    <div id="setup-ui" class="setup-box">
        <h3 style="color:#f1c40f; margin-top:0;">ğŸ® æˆ¿ä¸»è¨­å®š</h3>
        <label>ä½ æƒ³ç©å¹¾äººå±€ï¼Ÿ</label>
        <select id="player-count">
            <option value="2">2 äººå±€ (å–®æŒ‘ + AI)</option>
            <option value="3">3 äººå±€</option>
            <option value="4">4 äººå±€</option>
            <option value="5">5 äººå±€</option>
            <option value="6" selected>6 äººå±€ (æœ€åˆºæ¿€)</option>
        </select>
        <div id="connected-info" style="margin:15px 0; color:#4caf50; font-weight:bold;">å·²é€£ç·šçš„æœ‹å‹: 0</div>
        <button class="main-btn" onclick="hostStart()">é–‹å§‹éŠæˆ² (ä¸è¶³äººæ•¸ç”±AIè£œ)</button>
        
        <hr style="border:0.5px solid #333; margin:20px 0;">
        <h3 style="color:#3498db; margin-top:0;">ğŸ¤ åŠ å…¥æœ‹å‹</h3>
        <input type="text" id="join-id" placeholder="è¼¸å…¥æˆ¿ä¸»ID" style="width:120px; padding:10px; border-radius:5px; border:none; text-align:center;">
        <button class="join-btn" onclick="connectToHost()">é€£ç·š</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display" style="color:#f1c40f;">æ­£åœ¨åˆ†é…è§’è‰²...</h3>
        <div id="log"></div>
        <div id="board"></div>
        <button id="next-phase-btn" class="main-btn" style="display:none; width:200px;" onclick="forceNextPhase()">å¼·åˆ¶é€²å…¥ä¸‹ä¸€éšæ®µ</button>
    </div>

<script>
    const peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
    let conns = [], myConn, isHost = false, myIdx = -1;
    let game = { players: [], phase: "WAITING", logs: [], countdown: 0 };

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    
    // æˆ¿ä¸»æ¥è½é€£ç·š
    peer.on('connection', c => {
        isHost = true;
        conns.push(c);
        document.getElementById('connected-info').innerText = `å·²é€£ç·šçš„æœ‹å‹: ${conns.length}`;
        addLog(`æœ‹å‹ ${c.peer} å·²åŠ å…¥æˆ¿é–“`);
        c.on('data', data => handleData(data));
    });

    function connectToHost() {
        const id = document.getElementById('join-id').value;
        if(!id) return alert("è«‹è¼¸å…¥ID");
        myConn = peer.connect(id);
        myConn.on('data', data => handleData(data));
        document.getElementById('setup-ui').innerHTML = "<h3 style='color:#3498db;'>âœ… å·²é€£ç·šï¼Œç­‰å¾…æˆ¿ä¸»é–‹å±€...</h3>";
    }

    function hostStart() {
        isHost = true;
        const total = parseInt(document.getElementById('player-count').value);
        
        // æ ¹æ“šäººæ•¸åˆ†é…è§’è‰²
        let roles = ["ç‹¼äºº", "é è¨€å®¶", "å¥³å·«", "æ‘æ°‘", "çµäºº", "ç‹¼äºº"].slice(0, total);
        roles = roles.sort(() => Math.random() - 0.5);

        game.players = [];
        for(let i=0; i<total; i++) {
            let pType = (i === 0) ? "HOST" : (i <= conns.length ? "CLIENT" : "AI");
            game.players.push({
                id: i,
                name: pType === "AI" ? `AI-${i+1}` : `ç©å®¶-${i+1}`,
                role: roles[i],
                isAlive: true,
                isAI: pType === "AI"
            });
        }
        myIdx = 0;
        game.phase = "NIGHT";
        game.logs = [];
        addLog("ğŸŒ™ éŠæˆ²é–‹å§‹ï¼å¤©é»‘è«‹é–‰çœ¼...");
        broadcastSync();
        if(game.players[0].role !== "ç‹¼äºº" && game.players[0].role !== "é è¨€å®¶") {
            setTimeout(checkAiTurn, 2000); 
        }
    }

    function handleData(data) {
        if(data.type === "SYNC") {
            game = data.game;
            myIdx = data.idx;
            updateUI();
        } else if(data.type === "ACTION") {
            processAction(data.target, data.from, data.act);
        }
    }

    function broadcastSync() {
        if(!isHost) return;
        updateUI();
        conns.forEach((c, i) => c.send({ type: "SYNC", game: game, idx: i+1 }));
    }

    function addLog(m) {
        game.logs.push(`> ${m}`);
        if(game.logs.length > 10) game.logs.shift();
    }

    function updateUI() {
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
        const me = game.players[myIdx];
        document.getElementById('role-display').innerText = `ä½ çš„èº«åˆ†ï¼šã€${me.role}ã€‘ (${me.isAlive?'å­˜æ´»':'æ­»äº¡'})`;
        document.getElementById('timer').innerText = game.phase === "NIGHT" ? "ğŸŒ™ é»‘å¤œéšæ®µ" : "â˜€ï¸ ç™½å¤©è¨è«–";
        document.getElementById('log').innerHTML = game.logs.join('<br>');
        
        const board = document.getElementById('board');
        board.innerHTML = "";
        game.players.forEach((p, i) => {
            const card = document.createElement('div');
            card.className = `card ${p.isAlive?'':'dead'} ${i===myIdx?'my-card':''}`;
            // ç‹¼äººéšŠå‹å¯ä»¥çœ‹åˆ°å½¼æ­¤
            const canSee = (i===myIdx || !p.isAlive || (me.role==='ç‹¼äºº' && p.role==='ç‹¼äºº'));
            card.innerHTML = `<b>${p.name}</b><br>${canSee ? p.role : '???'}`;
            
            if(p.isAlive && me.isAlive && i!==myIdx) {
                if(game.phase === "NIGHT") {
                    if(me.role === "ç‹¼äºº") card.innerHTML += `<button class="main-btn" style="font-size:12px; padding:5px; margin:5px 0;" onclick="doAct(${i},'KILL')">æ®ºæ­»</button>`;
                    if(me.role === "é è¨€å®¶") card.innerHTML += `<button class="main-btn" style="font-size:12px; padding:5px; margin:5px 0;" onclick="doAct(${i},'CHECK')">é©—äºº</button>`;
                } else if(game.phase === "VOTE") {
                    card.innerHTML += `<button class="main-btn" style="font-size:12px; padding:5px; margin:5px 0;" onclick="doAct(${i},'VOTE')">æŠ•ç¥¨</button>`;
                }
            }
            board.appendChild(card);
        });
        
        if(isHost) document.getElementById('next-phase-btn').style.display = "inline-block";
    }

    function doAct(target, act) {
        if(isHost) processAction(target, 0, act);
        else myConn.send({ type: "ACTION", target: target, from: myIdx, act: act });
    }

    function processAction(target, from, act) {
        if(!isHost) return;
        const p = game.players[target];
        if(act === "KILL") { p.isAlive = false; addLog(`æ˜¨æ™š ${p.name} æ…˜é­æ®ºå®³...`); game.phase = "VOTE"; }
        else if(act === "CHECK") { alert(`${p.name} æ˜¯ ${p.role==='ç‹¼äºº'?'å£äºº':'å¥½äºº'}`); game.phase = "VOTE"; }
        else if(act === "VOTE") { p.isAlive = false; addLog(`æŠ•ç¥¨çµæœï¼š${p.name} è¢«è™•æ±ºäº†`); game.phase = "NIGHT"; }
        
        checkWin();
        broadcastSync();
        if(game.phase === "NIGHT") setTimeout(checkAiTurn, 2000);
    }

    function checkAiTurn() {
        if(!isHost || game.phase !== "NIGHT") return;
        game.players.forEach((p, i) => {
            if(p.isAlive && p.isAI && p.role === "ç‹¼äºº") {
                const targets = game.players.filter(v => v.isAlive && v.role !== "ç‹¼äºº");
                if(targets.length > 0) {
                    const t = targets[Math.floor(Math.random()*targets.length)];
                    processAction(t.id, i, "KILL");
                }
            }
        });
    }

    function checkWin() {
        const wolf = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const human = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if(wolf === 0) { alert("ğŸ‰ å¥½äººå‹åˆ©ï¼"); location.reload(); }
        else if(wolf >= human) { alert("ğŸº ç‹¼äººå‹åˆ©ï¼"); location.reload(); }
    }

    function forceNextPhase() {
        game.phase = (game.phase === "NIGHT") ? "VOTE" : "NIGHT";
        addLog("ç³»çµ±ï¼šå¼·åˆ¶åˆ‡æ›éšæ®µ");
        broadcastSync();
        if(game.phase === "NIGHT") setTimeout(checkAiTurn, 1000);
    }
</script>
</body>
</html>
