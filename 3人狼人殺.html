<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>3äººç‹¼äººæ®ºï¼šä¸€éµé–‹æˆ°ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        #log { width: 95%; max-width: 800px; height: 180px; background: #000; padding: 10px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 14px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 2px solid #e74c3c; box-shadow: 0 0 15px rgba(231, 76, 60, 0.4); }
        .btn-main { background: #e74c3c; color: white; padding: 15px 30px; border: none; border-radius: 8px; font-size: 18px; cursor: pointer; margin: 10px; font-weight: bold; }
        .btn-main:hover { background: #c0392b; transform: scale(1.05); }
        #board { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; width: 100%; max-width: 950px; }
        .card { background: #263238; border: 2px solid #455a64; padding: 10px; border-radius: 10px; text-align: center; position: relative; }
        .card.is-human { border-color: #3498db; background: #2c3e50; }
        .btn-act { background: #ff9800; border: none; color: black; padding: 5px 10px; border-radius: 5px; margin-top: 5px; cursor: pointer; width: 100%; font-weight: bold; }
    </style>
</head>
<body>

    <h2 id="room-status">ç­‰å¾…å°å°è§£é™¤...</h2>
    <div id="log">ã€ç³»çµ±æç¤ºã€‘æˆ¿ä¸»è«‹è¨­å®šç¸½äººæ•¸ä¸¦é»æ“Šã€Œç«‹åˆ»é–‹å§‹éŠæˆ²ã€ï¼Œä¸å¤ çš„äººæ•¸æœƒç”± AI è£œæ»¿ã€‚</div>

    <div id="setup-area" class="setup-box">
        <p>ä½ çš„é€£ç·š ID: <b id="my-id" style="color:#f1c40f">---</b></p>
        <div id="host-controls">
            <label>è¨­å®šç¸½éŠæˆ²äººæ•¸ (3-23äºº): </label><br>
            <input type="number" id="total-players" value="6" min="3" max="23" style="font-size: 20px; width: 60px; text-align: center; margin: 10px;"><br>
            <button class="btn-main" onclick="startGame()">âš”ï¸ ç«‹åˆ»é–‹å§‹éŠæˆ² (è£œæ»¿AI)</button>
        </div>
        <hr style="border: 0.5px solid #333;">
        <div id="join-controls">
            <input type="text" id="join-id" placeholder="è¼¸å…¥å¥½å‹ ID" style="padding: 10px; border-radius: 5px; border:none;">
            <button onclick="connectToHost()" style="padding: 10px 20px; border-radius: 5px; cursor:pointer;">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="board" style="display:none; margin-top:20px;"></div>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        let peer = new Peer();
        let myId, myConn, myName = "å°å®¥é ˜ä¸»";
        let isHost = true;
        let connections = [];
        let game = { phase: "WAITING", players: [], logs: [], nightActions: {} };
        let myIndex = 0;

        peer.on('open', id => {
            myId = id;
            document.getElementById('my-id').innerText = id;
            addLog("é€£ç·šå·²å°±ç·’ã€‚åˆ†äº«ä½ çš„ ID çµ¦å°å¸Œå§Šå§Šå§ï¼");
        });

        // æˆ¿ä¸»æ¥æ”¶é€£ç·š
        peer.on('connection', conn => {
            isHost = true;
            connections.push(conn);
            addLog("æ–°ç©å®¶åŠ å…¥ï¼ç›®å‰é€£ç·šäººæ•¸: " + connections.length);
            conn.on('data', data => handleData(data, conn));
        });

        function connectToHost() {
            const targetId = document.getElementById('join-id').value;
            if (!targetId) return;
            isHost = false;
            myConn = peer.connect(targetId);
            document.getElementById('host-controls').style.display = 'none';
            addLog("å˜—è©¦é€£ç·šåˆ°æˆ¿ä¸»...");
            myConn.on('data', data => handleData(data, myConn));
        }

        function addLog(msg) {
            const log = document.getElementById('log');
            game.logs.push(msg);
            log.innerHTML = game.logs.join('<br>');
            log.scrollTop = log.scrollHeight;
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function startGame() {
            if (!isHost) return;
            const total = parseInt(document.getElementById('total-players').value);
            game.players = [];
            
            // 1. åŠ å…¥æˆ¿ä¸»
            game.players.push({ name: myName, role: "", isAlive: true, isAI: false, connId: myId });
            
            // 2. åŠ å…¥å·²é€£ç·šçš„çœŸäºº
            connections.forEach((c, idx) => {
                game.players.push({ name: "ç©å®¶ " + (idx+2), role: "", isAlive: true, isAI: false, connId: c.peer });
            });

            // 3. å‰©é¤˜ä½å­è£œæ»¿ AI
            while (game.players.length < total) {
                game.players.push({ name: "AI è²“å¥´ " + (game.players.length + 1), role: "", isAlive: true, isAI: true });
            }

            // 4. åˆ†é…è·æ¥­
            assignRoles();
            game.phase = "NIGHT";
            game.logs = ["â˜… éŠæˆ²é–‹å§‹ï¼é€²å…¥é»‘æš—ä¹‹å¤œ â˜…"];
            
            broadcast({ type: "SYNC", game: game });
            render();
        }

        function assignRoles() {
            const roles = ["ç‹¼äºº", "é è¨€å®¶", "å¥³å·«", "å¹³æ°‘"];
            game.players.forEach((p, i) => {
                p.role = roles[i % roles.length];
            });
            // æ´—ç‰Œ
            game.players.sort(() => Math.random() - 0.5);
        }

        function handleData(data, conn) {
            if (data.type === "SYNC") {
                game = data.game;
                // æ›´æ–°æˆ‘çš„ç´¢å¼•
                myIndex = game.players.findIndex(p => p.connId === myId);
                render();
            }
        }

        function broadcast(data) {
            connections.forEach(c => c.send(data));
        }

        function render() {
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('board').style.display = 'grid';
            document.getElementById('room-status').innerText = "ç•¶å‰éšæ®µ: " + game.phase;
            
            const board = document.getElementById('board');
            board.innerHTML = "";
            game.players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = `card ${!p.isAI ? 'is-human' : ''}`;
                div.innerHTML = `
                    <small>${p.isAI ? 'ğŸ¤– AI' : 'ğŸ‘¤ çœŸäºº'}</small><br>
                    <b>${p.name}</b><br>
                    <span>${(i === myIndex || !p.isAlive) ? p.role : '???'}</span>
                `;
                board.appendChild(div);
            });
            
            const log = document.getElementById('log');
            log.innerHTML = game.logs.join('<br>');
            log.scrollTop = log.scrollHeight;
        }
    </script>
</body>
</html>
