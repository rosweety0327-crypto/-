<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼š12äººæ…¢é€Ÿç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 180px; background: #000; padding: 10px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 5px; }
        .chat-box { width: 95%; max-width: 650px; display: flex; gap: 8px; margin-bottom: 10px; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 6px; border: 1px solid #3498db; background: #1c2732; color: white; }
        .send-btn { padding: 10px 20px; background: #3498db; color: white; border-radius: 6px; cursor: pointer; border:none; }
        .setup-box { background: #1c2732; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #3498db; margin-top: 10px; }
        #board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 800px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 8px; text-align: center; border-radius: 8px; font-size: 11px; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; }
        .btn-act { padding: 5px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 5px; width: 100%; font-size: 11px; font-weight: bold; }
        .main-btn { padding: 12px 25px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <h2 style="margin:5px 0;">ğŸº ç‹¼äººæ®ºï¼š12äººå…¨å“¡æŠ•ç¥¨æ…¢é€Ÿç‰ˆ</h2>
    <div id="status" style="color:#ffa000; font-size:14px; margin-bottom:5px;">ID: <span id="my-id">...</span></div>

    <div id="setup-ui" class="setup-box">
        <button class="main-btn" onclick="hostStart()">æˆ¿ä¸»ï¼šé–‹å±€ (è£œ AI è‡³ 12 äºº)</button>
        <p id="connected-info" style="color:#4caf50; font-size:14px;">å·²é€£ç·šæœ‹å‹: 0</p>
        <input type="text" id="join-id" placeholder="è¼¸å…¥æˆ¿ä¸» ID" style="padding:8px; width:120px; text-align:center;">
        <button onclick="connect()" style="padding:8px 15px; background:#3498db; color:white; border:none; border-radius:5px;">åŠ å…¥</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display" style="color:#fdd835; margin:5px 0;">ç­‰å¾…è§’è‰²...</h3>
        <div id="log"></div>
        <div class="chat-box">
            <input type="text" id="chat-input" placeholder="æŒ‰ Enter ç™¼è¨€..." onkeypress="if(event.key==='Enter') sendChat()">
            <button class="send-btn" onclick="sendChat()">ç™¼è¨€</button>
        </div>
        <div id="board"></div>
        <button id="next-btn" class="main-btn" style="display:none; background:#1565c0;" onclick="forceNext()">æˆ¿ä¸»ï¼šé€²å…¥ä¸‹ä¸€å¤©</button>
    </div>

<script>
    const peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
    let conns = [], myConn, isHost = false, myIdx = -1;
    let game = { players: [], phase: "WAITING", logs: [], wolfVotes: {}, victim: null, witchUsed: {heal:false, poison:false} };

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { isHost = true; conns.push(c); document.getElementById('connected-info').innerText = `å·²é€£ç·šæœ‹å‹: ${conns.length}`; c.on('data', d => handleData(d)); });

    function connect() {
        myConn = peer.connect(document.getElementById('join-id').value);
        myConn.on('data', d => handleData(d));
        document.getElementById('setup-ui').innerHTML = "<h3>âœ… é€£ç·šæˆåŠŸ</h3>";
    }

    function hostStart() {
        isHost = true;
        const roles = ["ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","é¨å£«","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘"].sort(() => Math.random() - 0.5);
        game.players = Array.from({length: 12}, (_, i) => ({
            id: i, name: i === 0 ? "å°å®¥é ˜ä¸»" : (i <= conns.length ? `ç©å®¶${i+1}` : `AI-${i+1}`),
            role: roles[i], isAlive: true, isAI: i > conns.length
        }));
        myIdx = 0; game.phase = "NIGHT"; 
        addLog("ğŸŒ™ 12 äººå±€é–‹å§‹... è«‹ç¨å€™...");
        setTimeout(() => { addLog("ğŸŒ• å¤©é»‘è«‹é–‰çœ¼ï¼Œç‹¼äººé–‹å§‹æŠ•ç¥¨ã€‚"); broadcast(); aiAction(); }, 2000);
    }

    function handleData(data) {
        if(data.type === "SYNC") { game = data.game; myIdx = data.idx; updateUI(); }
        else if(data.type === "CHAT") { addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`); }
        else if(data.type === "ACTION") { processAction(data.target, data.from, data.sub); }
        else if(data.type === "MSG") { alert(data.msg); }
    }

    function broadcast() { if(!isHost) return; updateUI(); conns.forEach((c, i) => c.send({ type: "SYNC", game: game, idx: i+1 })); }

    function sendChat() {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        const chatData = { type: "CHAT", sender: game.players[myIdx].name, msg: input.value };
        addLog(`ğŸ’¬ ${chatData.sender}: ${chatData.msg}`);
        if(isHost) conns.forEach(c => c.send(chatData)); else myConn.send(chatData);
        input.value = "";
    }

    function addLog(m) { game.logs.push(`> ${m}`); if(game.logs.length > 20) game.logs.shift(); updateUI(); }

    function updateUI() {
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
        const me = game.players[myIdx];
        document.getElementById('role-display').innerText = `ã€${me.role}ã€‘ - ${me.isAlive?'å­˜æ´»':'æ·˜æ±°'}`;
        const logBox = document.getElementById('log'); logBox.innerHTML = game.logs.join('<br>'); logBox.scrollTop = logBox.scrollHeight;
        const board = document.getElementById('board'); board.innerHTML = "";
        game.players.forEach((p, i) => {
            const card = document.createElement('div');
            const canSee = (i===myIdx || !p.isAlive || (me.role==='ç‹¼äºº' && p.role==='ç‹¼äºº'));
            card.className = `card ${p.isAlive?'':'dead'} ${i===myIdx?'my-card':''}`;
            card.innerHTML = `<b>${i+1}.${p.name}</b><br>${canSee ? p.role : '???'}`;
            if(p.isAlive && me.isAlive) {
                if(game.phase === "NIGHT") {
                    if(me.role === "ç‹¼äºº" && i !== myIdx) card.innerHTML += `<button class="btn-act" onclick="doAct(${i},'KILL')">ç‹¼äººæŠ•ç¥¨</button>`;
                    if(me.role === "é è¨€å®¶" && i !== myIdx) card.innerHTML += `<button class="btn-act" style="background:#2980b9" onclick="doAct(${i},'CHECK')">é©—äºº</button>`;
                    if(me.role === "å¥³å·«") {
                        if(i === game.victim && !game.witchUsed.heal) card.innerHTML += `<button class="btn-act" style="background:#27ae60" onclick="doAct(${i},'HEAL')">æ•‘äºº</button>`;
                        if(i !== myIdx && !game.witchUsed.poison) card.innerHTML += `<button class="btn-act" style="background:#8e44ad" onclick="doAct(${i},'POISON')">æ¯’æ®º</button>`;
                    }
                } else if(game.phase === "VOTE" && i !== myIdx) card.innerHTML += `<button class="btn-act" style="background:#d35400" onclick="doAct(${i},'æŠ•ç¥¨')">æŠ•ç¥¨</button>`;
            }
            board.appendChild(card);
        });
        if(isHost) document.getElementById('next-btn').style.display = "inline-block";
    }

    function doAct(t, s) { if(isHost) processAction(t, myIdx, s); else myConn.send({ type: "ACTION", target: t, from: myIdx, sub: s }); }

    function processAction(t, f, s) {
        if(!isHost) return;
        const target = game.players[t];
        if(s === "KILL") {
            game.wolfVotes[f] = t;
            addLog(`${game.players[f].name} æŠ•ç¥¨æ“Šæ®º ${t+1}è™Ÿ`);
            const votes = Object.values(game.wolfVotes);
            const counts = {}; votes.forEach(v => counts[v] = (counts[v]||0)+1);
            game.victim = parseInt(Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b));
        } else if(s === "CHECK") {
            const res = `æŸ¥é©—ï¼š${t+1}è™Ÿ æ˜¯ ${target.role==='ç‹¼äºº'?'å£äºº':'å¥½äºº'}`;
            if(f === 0) alert(res); else conns[f-1].send({ type: "MSG", msg: res });
            addLog("é è¨€å®¶å·²æŸ¥é©—ã€‚");
        } else if(s === "HEAL") { game.victim = null; game.witchUsed.heal = true; addLog("å¥³å·«æ•‘å›äº†ç›®æ¨™ã€‚"); }
        else if(s === "POISON") { target.isAlive = false; game.witchUsed.poison = true; addLog(`${t+1}è™Ÿ è¢«æ¯’æ­»äº†ã€‚`); }
        else if(s === "æŠ•ç¥¨") { target.isAlive = false; addLog(`${target.name} è¢«å…¬æŠ•å‡ºå±€ã€‚`); game.phase = "NIGHT"; game.wolfVotes = {}; setTimeout(aiAction, 3000); }
        broadcast(); checkWin();
    }

    function aiAction() {
        if(!isHost || game.phase !== "NIGHT") return;
        game.players.forEach(p => {
            if(p.isAlive && p.isAI) {
                if(p.role === "ç‹¼äºº") {
                    const ts = game.players.filter(x => x.isAlive && x.role !== "ç‹¼äºº");
                    const pick = ts[Math.floor(Math.random()*ts.length)].id;
                    setTimeout(() => { processAction(pick, p.id, "KILL"); }, 3000 + (Math.random()*2000));
                }
            }
        });
    }

    function forceNext() {
        if(game.phase === "NIGHT") {
            if(game.victim !== null) { game.players[game.victim].isAlive = false; addLog(`ğŸŒ… å¤©äº®äº†ï¼Œ${game.victim+1}è™Ÿ æ˜¨æ™šæ­»äº†ã€‚`); }
            else addLog("ğŸŒ… å¤©äº®äº†ï¼Œæ˜¨æ™šæ˜¯å¹³å®‰å¤œã€‚");
            game.phase = "VOTE";
        } else { game.phase = "NIGHT"; game.victim = null; addLog("ğŸŒ™ å¤©é»‘è«‹é–‰çœ¼..."); setTimeout(aiAction, 3000); }
        broadcast();
    }

    function checkWin() {
        const w = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const h = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if(w === 0) { alert("ğŸ‰ å¥½äººå‹åˆ©ï¼"); location.reload(); }
        else if(w >= h) { alert("ğŸº ç‹¼äººå‹åˆ©ï¼"); location.reload(); }
    }
</script>
</body>
</html>
