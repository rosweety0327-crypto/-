<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>3äººç‹¼äººæ®ºï¼šé ˜ä¸»ä¸€éµé–‹æˆ°ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        #log { width: 95%; max-width: 800px; height: 180px; background: #000; padding: 10px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 14px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 4px solid #e74c3c; width: 85%; max-width: 400px; }
        
        /* é€™æ˜¯ä½ çš„å¤§æŒ‰éˆ•ï¼Œä¿è­‰å‡ºç¾ï¼ */
        .btn-start-now { 
            background: linear-gradient(135deg, #e74c3c, #c0392b); 
            color: white; 
            padding: 20px; 
            border: none; 
            border-radius: 50px; 
            font-size: 24px; 
            cursor: pointer; 
            margin: 20px 0; 
            font-weight: bold; 
            width: 100%;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.6);
        }
        
        #board { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; width: 100%; max-width: 950px; }
        .card { background: #263238; border: 2px solid #455a64; padding: 10px; border-radius: 10px; text-align: center; }
        input { padding: 10px; border-radius: 5px; border: none; font-size: 16px; margin: 5px; }
    </style>
</head>
<body>

    <h2 id="room-status">ğŸ’€ é ˜ä¸»å¤§å»³ï¼šç­‰å¾…é–‹æˆ° ğŸ’€</h2>
    <div id="log">ã€ç³»çµ±æç¤ºã€‘æˆ¿ä¸»è«‹è¨­å®šäººæ•¸ï¼Œé»æ“Šä¸‹æ–¹å¤§ç´…éˆ•ç«‹åˆ»é–‹å§‹ï¼</div>

    <div id="setup-area" class="setup-box">
        <p>ä½ çš„é€£ç·š ID: <b id="my-id" style="color:#f1c40f">---</b></p>
        
        <label>éŠæˆ²ç¸½äººæ•¸ (3-23äºº):</label><br>
        <input type="number" id="total-players" value="6" min="3" max="23"><br>
        
        <button class="btn-start-now" id="real-start-btn" onclick="startGame()">âš”ï¸ ç«‹åˆ»é–‹å§‹éŠæˆ²</button>
        
        <div id="join-controls" style="margin-top:20px; border-top: 1px solid #444; padding-top: 15px;">
            <p style="font-size:12px;">å¦‚æœæ˜¯å°å¸Œè¦åŠ å…¥ï¼Œè«‹è¼¸å…¥ IDï¼š</p>
            <input type="text" id="join-id" placeholder="å¥½å‹ ID">
            <button onclick="connectToHost()">åŠ å…¥æˆ¿é–“</button>
        </div>
    </div>

    <div id="board" style="display:none; margin-top:20px;"></div>

    <script>
        let peer = new Peer();
        let myId, connections = [], isHost = true, game = { phase: "WAITING", players: [], logs: [] };

        peer.on('open', id => {
            myId = id;
            document.getElementById('my-id').innerText = id;
            addLog("é€£ç·š ID å·²å°±ç·’ï¼å¯ä»¥é»æ“Šã€Œç«‹åˆ»é–‹å§‹ã€æˆ–ç­‰éšŠå‹ã€‚");
        });

        peer.on('connection', conn => {
            connections.push(conn);
            addLog("æ–°ç©å®¶åŠ å…¥ï¼ç›®å‰é€£ç·šï¼š" + connections.length);
            conn.on('data', data => handleData(data, conn));
        });

        function connectToHost() {
            const targetId = document.getElementById('join-id').value;
            if (!targetId) return;
            isHost = false;
            let myConn = peer.connect(targetId);
            document.getElementById('real-start-btn').style.display = 'none'; // åªæœ‰æˆ¿ä¸»èƒ½é–‹
            addLog("å˜—è©¦é€£ç·šåˆ°æˆ¿ä¸»...");
            myConn.on('data', data => handleData(data, myConn));
        }

        function startGame() {
            if (!isHost) return;
            const total = parseInt(document.getElementById('total-players').value);
            game.players = [];
            
            // æˆ¿ä¸»
            game.players.push({ name: "å°å®¥é ˜ä¸»", role: "é è¨€å®¶", isAlive: true, isAI: false, connId: myId });
            
            // çœŸäºº
            connections.forEach((c, idx) => {
                game.players.push({ name: "ç©å®¶ " + (idx+2), role: "å¹³æ°‘", isAlive: true, isAI: false, connId: c.peer });
            });

            // è£œæ»¿ AI
            while (game.players.length < total) {
                game.players.push({ name: "AI è²“å¥´ " + (game.players.length + 1), role: "å¹³æ°‘", isAlive: true, isAI: true });
            }

            // éš¨æ©Ÿåˆ†ç‹¼äºº
            game.players[Math.floor(Math.random() * game.players.length)].role = "ç‹¼äºº";
            
            game.phase = "NIGHT";
            game.logs = ["â˜… éŠæˆ²å•Ÿå‹•ï¼é»‘æš—é™è‡¨ â˜…"];
            
            broadcast({ type: "SYNC", game: game });
            render();
        }

        function handleData(data, conn) {
            if (data.type === "SYNC") { game = data.game; render(); }
        }

        function broadcast(data) { connections.forEach(c => c.send(data)); }

        function addLog(msg) {
            const log = document.getElementById('log');
            game.logs.push(msg);
            log.innerHTML = game.logs.join('<br>');
            log.scrollTop = log.scrollHeight;
        }

        function render() {
            document.getElementById('setup-area').style.display = 'none';
            document.getElementById('board').style.display = 'grid';
            document.getElementById('room-status').innerText = "ç•¶å‰éšæ®µ: " + game.phase;
            const board = document.getElementById('board');
            board.innerHTML = "";
            game.players.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<b>${p.name}</b><br><small>${p.isAI ? 'ğŸ¤–' : 'ğŸ‘¤'}</small><br><span>${p.role}</span>`;
                board.appendChild(div);
            });
        }
    </script>
</body>
</html>
