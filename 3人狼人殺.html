<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>23äººç‹¼äººæ®ºï¼šçœŸäººäººæ•¸å¯èª¿ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        #log { width: 95%; max-width: 800px; height: 150px; background: #000; padding: 10px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 12px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #3498db; max-width: 400px; }
        #board { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; width: 100%; max-width: 950px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 8px; text-align: center; border-radius: 8px; font-size: 11px; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; background: #37474f; }
        .card.is-human { border: 2px solid #2ecc71; } /* åªè¦æ˜¯çœŸäººå°±ç™¼ç¶ å…‰ */
        .btn-act { padding: 3px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 4px; width: 100%; font-size: 10px; }
        .main-btn { padding: 10px 30px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px; }
        .chat-ui { width: 95%; max-width: 800px; display: flex; gap: 5px; margin-bottom: 10px; }
        #chat-input { flex-grow: 1; padding: 8px; background: #1c2732; color: white; border: 1px solid #37474f; }
        .player-tag { font-size: 9px; padding: 2px 4px; border-radius: 3px; background: #555; margin-bottom: 2px; display: inline-block; }
    </style>
</head>
<body>

    <h2>ğŸº è±ªè¯ 23 äººå±€ (çœŸäººäººæ•¸å‹•æ…‹èª¿æ•´)</h2>
    <div id="status" style="color:#ffa000;">ä¼ºæœå™¨ ID: <span id="my-id">...</span> | ç•¶å‰é€£ç·šçœŸäºº: <span id="conn-count">1</span> äºº</div>

    <div id="setup-ui" class="setup-box">
        <p>ä½ çš„æš±ç¨±ï¼š<input type="text" id="user-name" value="ç©å®¶" style="padding:5px; width:100px;"></p>
        <hr>
        <div id="host-only-setup" style="display:none;">
            <p style="color:#2ecc71">ä½ æ˜¯æˆ¿ä¸»ï¼Œè«‹ç­‰å¾…æœ‹å‹é€£ç·šå¾ŒæŒ‰é–‹å§‹</p>
            <button onclick="hostStartGame()" class="main-btn">å…¨å“¡åˆ°é½Šï¼Œé–‹å§‹éŠæˆ²</button>
        </div>
        <div id="guest-setup">
            <input type="text" id="join-id" placeholder="è¼¸å…¥æˆ¿ä¸» ID" style="padding:10px; width:120px;">
            <button onclick="connectAsGuest()">åŠ å…¥æˆ¿é–“</button>
            <p>æˆ–</p>
            <button onclick="beHost()" style="background:#2980b9; color:white;">æˆ‘ç•¶æˆ¿ä¸»</button>
        </div>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display">ç­‰å¾…éŠæˆ²é–‹å§‹...</h3>
        <div id="log"></div>
        <div class="chat-ui">
            <input type="text" id="chat-input" placeholder="æ‰“å­—è¨è«–..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">å‚³é€</button>
        </div>
        <div id="board"></div>
    </div>

<script>
    let peer;
    let connections = []; 
    let myConn;           
    let isHost = false;
    let myName = "";
    let myIndex = -1;
    let connectedHumans = []; // æˆ¿ä¸»ç´€éŒ„ï¼š[{conn, name}]

    let game = {
        players: [], phase: "WAITING", logs: [],
        nightActions: { wolfTarget: null },
        votes: {}
    };

    // --- é€£ç·šè¨­å®š ---
    function beHost() {
        isHost = true;
        myName = document.getElementById('user-name').value;
        const id = Math.floor(1000 + Math.random() * 9000).toString();
        peer = new Peer(id);
        peer.on('open', id => { 
            document.getElementById('my-id').innerText = id;
            document.getElementById('host-only-setup').style.display = "block";
            document.getElementById('guest-setup').style.display = "none";
            addLog(`ç³»çµ±ï¼šæˆ¿ä¸» ${myName} å·²é–‹æˆ¿ï¼ŒID æ˜¯ ${id}`);
            connectedHumans.push({ name: myName, conn: null }); // æˆ¿ä¸»è‡ªå·±æ˜¯ç¬¬ä¸€å€‹
        });
        peer.on('connection', conn => {
            conn.on('open', () => {
                // ç­‰å¾…å°æ–¹å‚³é€æš±ç¨±
                conn.on('data', data => {
                    if (data.type === "JOIN_NAME") {
                        connectedHumans.push({ name: data.name, conn: conn });
                        updateConnCount();
                        addLog(`ç³»çµ±ï¼š${data.name} å·²åŠ å…¥æˆ¿é–“`);
                        broadcast({ type: "CHAT", sender: "ç³»çµ±", msg: `${data.name} é€²å…¥äº†æˆ¿é–“` });
                    }
                    handleHostData(conn, data);
                });
            });
        });
        initUI();
    }

    function connectAsGuest() {
        isHost = false;
        myName = document.getElementById('user-name').value;
        const hostId = document.getElementById('join-id').value;
        peer = new Peer();
        peer.on('open', () => {
            myConn = peer.connect(hostId);
            myConn.on('open', () => {
                myConn.send({ type: "JOIN_NAME", name: myName });
                addLog("ç³»çµ±ï¼šæˆåŠŸé€£ç·šåˆ°æˆ¿ä¸»ï¼Œç­‰å¾…é–‹å§‹...");
            });
            setupGuestListener(myConn);
            initUI();
        });
    }

    function updateConnCount() {
        document.getElementById('conn-count').innerText = connectedHumans.length;
    }

    function initUI() {
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
    }

    // --- æˆ¿ä¸»é‚è¼¯ ---
    function hostStartGame() {
        const totalPlayers = 23;
        const roles = ["ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","å®ˆè¡›","ç™½ç—´","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘"].sort(() => Math.random() - 0.5);
        
        game.players = [];
        
        // 1. å…ˆæŠŠé€£ç·šçš„çœŸäººæ”¾é€²å»
        connectedHumans.forEach((h, i) => {
            game.players.push({ id: i, name: h.name, role: roles[i], isAlive: true, isAI: false });
        });

        // 2. å‰©ä¸‹çš„ä½ç½®è£œ AI
        for(let i = connectedHumans.length; i < totalPlayers; i++) {
            game.players.push({ id: i, name: `AI-${i+1}`, role: roles[i], isAlive: true, isAI: true });
        }
        
        game.phase = "NIGHT";
        addLog("ğŸŒ™ éŠæˆ²é–‹å§‹ï¼å¤©é»‘è«‹é–‰çœ¼...");
        sync();
    }

    function handleHostData(conn, data) {
        if (data.type === "CHAT") broadcast({ type: "CHAT", sender: data.sender, msg: data.msg });
        if (data.type === "ACTION") handleAction(data.target, data.fromIdx, data.subType);
    }

    function handleAction(targetIdx, fromIdx, subType) {
        if (!isHost) return;
        if (subType === "KILL") { game.nightActions.wolfTarget = targetIdx; addLog(`ç‹¼äººè¡Œå‹•å®Œç•¢`); }
        if (subType === "VOTE") { game.votes[fromIdx] = targetIdx; }
        sync();
    }

    // --- é€šç”¨èˆ‡åŒæ­¥ ---
    function sync() {
        if (!isHost) return;
        myIndex = 0;
        updateUI();
        connectedHumans.forEach((h, index) => {
            if (h.conn) {
                h.conn.send({ type: "SYNC", game: game, yourIndex: index });
            }
        });
    }

    function setupGuestListener(conn) {
        conn.on('data', data => {
            if (data.type === "CHAT") addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`);
            else if (data.type === "SYNC") { game = data.game; myIndex = data.yourIndex; updateUI(); }
        });
    }

    function broadcast(data) {
        if (isHost) {
            connectedHumans.forEach(h => { if(h.conn) h.conn.send(data); });
            if (data.type === "CHAT") addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`);
        }
    }

    function updateUI() {
        const me = game.players[myIndex];
        if (!me) return;
        document.getElementById('role-display').innerText = `æˆ‘æ˜¯ï¼š${me.name} | èº«åˆ†ï¼š${me.role} (${me.isAlive?'å­˜æ´»':'æ­»äº¡'})`;
        
        const board = document.getElementById('board');
        board.innerHTML = "";
        game.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `card ${p.isAlive ? '' : 'dead'} ${i === myIndex ? 'my-card' : ''} ${!p.isAI ? 'is-human' : ''}`;
            
            const canSee = (i === myIndex || !p.isAlive);
            div.innerHTML = `
                <div class="player-tag">${p.isAI ? 'AI' : 'çœŸäºº'}</div><br>
                <b>${i+1}. ${p.name}</b><br>
                <small>${canSee ? p.role : '???'}</small>
            `;
            
            if (p.isAlive && me.isAlive && i !== myIndex) {
                if (game.phase === "NIGHT" && me.role === "ç‹¼äºº") div.innerHTML += `<button class="btn-act" onclick="doAction(${i}, 'KILL')">æ“Šæ®º</button>`;
                if (game.phase === "VOTE") div.innerHTML += `<button class="btn-act" onclick="doAction(${i}, 'VOTE')">æŠ•ç¥¨</button>`;
            }
            board.appendChild(div);
        });
    }

    function doAction(target, type) {
        if (isHost) handleAction(target, myIndex, type);
        else myConn.send({ type: "ACTION", target: target, fromIdx: myIndex, subType: type });
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;
        const chatData = { type: "CHAT", sender: myName, msg: msg };
        if (isHost) broadcast(chatData);
        else myConn.send(chatData);
        input.value = "";
    }

    function addLog(m) {
        const log = document.getElementById('log');
        log.innerHTML += `<div>> ${m}</div>`;
        log.scrollTop = log.scrollHeight;
    }
</script>
</body>
</html>