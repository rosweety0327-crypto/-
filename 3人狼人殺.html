<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼šé ˜ä¸» 12 äººé€²åŒ–ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 180px; background: #000; padding: 10px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #3498db; margin-top: 10px; }
        #board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; width: 100%; max-width: 800px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 8px; text-align: center; border-radius: 8px; font-size: 11px; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; box-shadow: 0 0 8px rgba(253, 216, 53, 0.4); }
        .btn-act { padding: 4px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 5px; width: 100%; font-size: 11px; }
        .chat-area { width: 95%; max-width: 650px; display: flex; gap: 5px; margin-bottom: 10px; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #37474f; background: #1c2732; color: white; }
        .main-btn { padding: 10px 20px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <h2 style="margin:10px 0;">ğŸº ç‹¼äººæ®ºï¼š12äººå…¨è·èƒ½é€²åŒ–ç‰ˆ</h2>
    <div id="status-bar" style="color:#ffa000; margin-bottom:10px;">æˆ‘çš„ ID: <span id="my-id">...</span></div>

    <div id="setup-ui" class="setup-box">
        <button class="main-btn" onclick="hostStart()">å•Ÿå‹• 12 äººå±€ (AIè‡ªå‹•è£œä½)</button>
        <div id="connected-info" style="margin:10px 0; font-size:14px; color:#4caf50;">ç­‰å¾…é€£ç·š...</div>
        <input type="text" id="join-id" placeholder="æˆ¿ä¸» ID" style="width:100px; padding:5px; text-align:center;">
        <button onclick="connect()" style="padding:5px 15px; background:#3498db; color:white; border:none; border-radius:5px;">åŠ å…¥</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display" style="color:#fdd835; margin:5px 0;">èº«åˆ†åˆ†é…ä¸­...</h3>
        
        <div id="log"></div>
        
        <div class="chat-area">
            <input type="text" id="chat-input" placeholder="èªªé»ä»€éº¼ä¾†å¹²æ“¾å¤§å®¶..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()" style="padding:8px 15px; background:#2980b9; color:white; border:none; border-radius:5px;">ç™¼é€</button>
        </div>

        <div id="board"></div>
        <button id="next-btn" class="main-btn" style="display:none; margin-top:15px; background:#1565c0;" onclick="forceNext()">æˆ¿ä¸»ï¼šé€²å…¥ä¸‹ä¸€å¤©</button>
    </div>

<script>
    const peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
    let conns = [], myConn, isHost = false, myIdx = -1;
    let game = { players: [], phase: "WAITING", logs: [], wolfVotes: {}, victim: null, witchUsed: {heal:false, poison:false} };

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => { isHost=true; conns.push(c); c.on('data', d => handleData(d)); });

    function connect() {
        myConn = peer.connect(document.getElementById('join-id').value);
        myConn.on('data', d => handleData(d));
        document.getElementById('setup-ui').innerHTML = "<h3>âœ… å·²æˆåŠŸé€£ç·šï¼Œç­‰å¾…æˆ¿ä¸»é–‹å±€</h3>";
    }

    function hostStart() {
        isHost = true;
        const roles = ["ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","é¨å£«","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘"].sort(() => Math.random() - 0.5);
        game.players = Array.from({length: 12}, (_, i) => ({
            id: i, name: i === 0 ? "å°å®¥é ˜ä¸»" : (i <= conns.length ? `æœ‹å‹${i}` : `AI-${i+1}`),
            role: roles[i], isAlive: true, isAI: i > conns.length
        }));
        myIdx = 0; game.phase = "NIGHT"; game.logs = [];
        addLog("ğŸŒ™ éŠæˆ²é–‹å§‹ï¼å¤©é»‘è«‹é–‰çœ¼ï¼Œç‹¼äººè«‹æ®ºäººã€‚");
        broadcast();
        aiBehavior();
    }

    function handleData(data) {
        if(data.type === "SYNC") { game = data.game; myIdx = data.idx; updateUI(); }
        else if(data.type === "CHAT") { addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`); }
        else if(data.type === "ACTION") { processAction(data.target, data.from, data.sub); }
        else if(data.type === "MSG") { alert(data.msg); }
    }

    function broadcast() { 
        if(!isHost) return; updateUI(); 
        conns.forEach((c, i) => c.send({ type: "SYNC", game: game, idx: i+1 })); 
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim(); if(!msg) return;
        const sender = game.players[myIdx].name;
        const chatData = { type: "CHAT", sender, msg };
        addLog(`ğŸ’¬ ${sender}: ${msg}`);
        if(isHost) conns.forEach(c => c.send(chatData)); else myConn.send(chatData);
        input.value = "";
    }

    function addLog(m) { game.logs.push(`> ${m}`); if(game.logs.length > 15) game.logs.shift(); updateUI(); }

    function updateUI() {
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
        const me = game.players[myIdx];
        document.getElementById('role-display').innerText = `ã€${me.role}ã€‘ - ${me.isAlive?'å­˜æ´»':'å·²æ·˜æ±°'}`;
        document.getElementById('log').innerHTML = game.logs.join('<br>');
        const l = document.getElementById('log'); l.scrollTop = l.scrollHeight;
        
        const board = document.getElementById('board'); board.innerHTML = "";
        game.players.forEach((p, i) => {
            const card = document.createElement('div');
            const canSee = (i===myIdx || !p.isAlive || (me.role==='ç‹¼äºº' && p.role==='ç‹¼äºº'));
            card.className = `card ${p.isAlive?'':'dead'} ${i===myIdx?'my-card':''}`;
            card.innerHTML = `<b>${i+1}.${p.name}</b><br>${canSee?p.role:'???'}`;

            if(p.isAlive && me.isAlive) {
                if(game.phase === "NIGHT") {
                    if(me.role === "ç‹¼äºº" && i!==myIdx) card.innerHTML += `<button class="btn-act" onclick="doAct(${i},'KILL')">ç‹¼äººæŠ•ç¥¨</button>`;
                    if(me.role === "é è¨€å®¶" && i!==myIdx) card.innerHTML += `<button class="btn-act" style="background:#2980b9" onclick="doAct(${i},'CHECK')">æŸ¥é©—</button>`;
                    if(me.role === "å¥³å·«") {
                        if(i === game.victim && !game.witchUsed.heal) card.innerHTML += `<button class="btn-act" style="background:#27ae60" onclick="doAct(${i},'HEAL')">æ•‘äºº</button>`;
                        if(i !== myIdx && !game.witchUsed.poison) card.innerHTML += `<button class="btn-act" style="background:#8e44ad" onclick="doAct(${i},'POISON')">æŠ•æ¯’</button>`;
                    }
                } else if(game.phase === "VOTE" && i!==myIdx) {
                    card.innerHTML += `<button class="btn-act" style="background:#d35400" onclick="doAct(${i},'VOTE')">æ”¾é€æŠ•ç¥¨</button>`;
                }
            }
            board.appendChild(card);
        });
        if(isHost) document.getElementById('next-btn').style.display = "inline-block";
    }

    function doAct(t, s) { if(isHost) processAction(t, myIdx, s); else myConn.send({ type: "ACTION", target: t, from: myIdx, sub: s }); }

    function processAction(t, f, s) {
        if(!isHost) return;
        const target = game.players[t];
        if(s === "KILL") {
            game.wolfVotes[f] = t;
            addLog(`${game.players[f].name} æŠ•ç¥¨æƒ³æ®º ${t+1}è™Ÿ`);
            // ç‹¼äººå¤šæ•¸æ±ºåˆ¤å®š
            const votes = Object.values(game.wolfVotes);
            const counts = {}; votes.forEach(v => counts[v] = (counts[v]||0)+1);
            game.victim = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
        }
        else if(s === "CHECK") {
            const res = `æŸ¥é©—çµæœï¼š${t+1}è™Ÿ æ˜¯ ${target.role==='ç‹¼äºº'?'ç‹¼äºº':'å¥½äºº'}`;
            if(f === 0) alert(res); else conns[f-1].send({ type: "MSG", msg: res });
            addLog("é è¨€å®¶æŸ¥é©—äº†èº«åˆ†ã€‚");
        }
        else if(s === "HEAL") { game.victim = null; game.witchUsed.heal = true; addLog("å¥³å·«æ•‘å›äº†ä¸€æ¢å‘½ã€‚"); }
        else if(s === "POISON") { target.isAlive = false; game.witchUsed.poison = true; addLog("å¥³å·«æ¯’æ­»äº†ä¸€å€‹äººã€‚"); }
        else if(s === "VOTE") { target.isAlive = false; addLog(`${target.name} è¢«å…¬æŠ•å‡ºå±€ã€‚`); game.phase = "NIGHT"; game.wolfVotes = {}; }
        
        broadcast(); checkWin();
    }

    function aiBehavior() {
        if(!isHost || game.phase !== "NIGHT") return;
        game.players.forEach(p => {
            if(p.isAlive && p.isAI) {
                // AI ç‹¼äººæœ‰è‡ªå·±çš„çµæ®ºç›®æ¨™ï¼Œä¸ä¸€å®šè½é ˜ä¸»çš„
                if(p.role === "ç‹¼äºº" && !game.wolfVotes[p.id]) {
                    const targets = game.players.filter(x => x.isAlive && x.role !== "ç‹¼äºº");
                    const pick = targets[Math.floor(Math.random()*targets.length)].id;
                    processAction(pick, p.id, "KILL");
                    setTimeout(() => addLog(`ğŸ’¬ ${p.name}(ç‹¼éšŠäº¤æµ): æˆ‘è¦ºå¾—æ®º ${pick+1}è™Ÿ æ¯”è¼ƒå¥½ã€‚`), 2000);
                }
            }
        });
    }

    function forceNext() {
        if(game.phase === "NIGHT") {
            if(game.victim !== null) { game.players[game.victim].isAlive = false; addLog(`å¤ªé™½å‡èµ·ï¼Œ${parseInt(game.victim)+1}è™Ÿ æ˜¨æ™šæ­»äº†ã€‚`); }
            else addLog("æ˜¨æ™šæ˜¯å€‹å¹³å®‰å¤œã€‚");
            game.phase = "VOTE";
        } else { game.phase = "NIGHT"; aiBehavior(); }
        broadcast();
    }

    function checkWin() {
        const w = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const h = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if(w === 0) { alert("ğŸ‰ å¥½äººé™£ç‡Ÿå‹åˆ©ï¼"); location.reload(); }
        else if(w >= h) { alert("ğŸº ç‹¼äººé™£ç‡Ÿå‹åˆ©ï¼"); location.reload(); }
    }
</script>
</body>
</html>
