<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼šé ˜ä¸»çµ‚æ¥µ 12 äººç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* åš´æ ¼ç¶­æŒ 2 äººç‰ˆçš„ç‰ˆé¢é…ç½® */
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 180px; background: #000; padding: 12px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 2px solid #3498db; margin-top: 20px; }
        
        /* ç¶­æŒ 4 æ¬„é…ç½® */
        #board { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 800px; }
        
        .card { background: #263238; border: 1px solid #455a64; padding: 10px; text-align: center; border-radius: 10px; font-size: 12px; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; }
        
        .btn-act { padding: 5px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 5px; width: 100%; font-size: 11px; }
        .main-btn { padding: 12px 30px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; font-weight: bold; }
        #timer { font-size: 24px; color: #ff5252; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h2>ğŸº ç‹¼äººæ®º (12äººè£œä½+å¥³å·«å…¨æŠ€èƒ½)</h2>
    <div id="status" style="color:#ffa000; margin-bottom:10px;">æˆ‘çš„ ID: <span id="my-id">...</span></div>

    <div id="setup-ui" class="setup-box">
        <p style="color:#4caf50;">ç³»çµ±å°‡è‡ªå‹•è£œæ»¿ 12 äººå±€</p>
        <div id="connected-info" style="margin-bottom:15px;">å·²é€£ç·šæœ‹å‹: 0</div>
        <button class="main-btn" onclick="hostStart()">é–‹å•Ÿ 12 äººå¤§æŒ‘æˆ°</button>
        <hr style="border:0.5px solid #333; margin:20px 0;">
        <input type="text" id="join-id" placeholder="è¼¸å…¥ ID" style="padding:10px; width:120px; text-align:center;">
        <button onclick="connectToFriend()" style="padding:10px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer;">åŠ å…¥æˆ¿é–“</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display" style="color:#fdd835;">èº«åˆ†åˆ†é…ä¸­...</h3>
        <div id="log"></div>
        <div id="board"></div>
        <button id="next-btn" class="main-btn" style="display:none; background:#1565c0;" onclick="forceNext()">æˆ¿ä¸»ï¼šé€²å…¥ä¸‹ä¸€éšæ®µ</button>
    </div>

<script>
    const peer = new Peer(Math.floor(1000 + Math.random() * 9000).toString());
    let conns = [], myConn, isHost = false, myIdx = -1;
    let game = { 
        players: [], phase: "WAITING", logs: [], 
        victim: null, witchHealUsed: false, witchPoisonUsed: false 
    };

    peer.on('open', id => document.getElementById('my-id').innerText = id);
    peer.on('connection', c => {
        isHost = true;
        conns.push(c);
        document.getElementById('connected-info').innerText = `å·²é€£ç·šæœ‹å‹: ${conns.length}`;
        c.on('data', data => handleData(data));
    });

    function connectToFriend() {
        myConn = peer.connect(document.getElementById('join-id').value);
        myConn.on('data', data => handleData(data));
        document.getElementById('setup-ui').innerHTML = "<h3>âœ… å·²æˆåŠŸé€£ç·šï¼Œç­‰å¾…æˆ¿ä¸»...</h3>";
    }

    function hostStart() {
        isHost = true;
        let roles = ["ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","é¨å£«","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘","æ‘æ°‘"].sort(() => Math.random() - 0.5);
        game.players = [];
        for(let i=0; i<12; i++) {
            let type = (i === 0) ? "HOST" : (i <= conns.length ? "CLIENT" : "AI");
            game.players.push({ id: i, name: type === "AI" ? `(AI)${i+1}` : `ç©å®¶${i+1}`, role: roles[i], isAlive: true, isAI: type === "AI" });
        }
        myIdx = 0; game.phase = "NIGHT"; game.logs = []; game.victim = null;
        addLog("ğŸŒ™ å¤©é»‘è«‹é–‰çœ¼ï¼Œ12 äººå±€æ­£å¼é–‹å§‹ã€‚");
        broadcastSync();
        processAI();
    }

    function handleData(data) {
        if(data.type === "SYNC") { game = data.game; myIdx = data.idx; updateUI(); }
        else if(data.type === "ACTION") { processAction(data.target, data.fromIdx, data.subType); }
        else if(data.type === "CHECK_RESULT") { alert(data.msg); }
    }

    function broadcastSync() {
        if(!isHost) return;
        updateUI();
        conns.forEach((c, i) => c.send({ type: "SYNC", game: game, idx: i+1 }));
    }

    function addLog(m) {
        game.logs.push(`> ${m}`);
        if(game.logs.length > 10) game.logs.shift();
    }

    function updateUI() {
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
        const me = game.players[myIdx];
        document.getElementById('role-display').innerText = `æˆ‘çš„èº«åˆ†ï¼š${me.role} (${me.isAlive?'å­˜æ´»':'æ­»äº¡'})`;
        document.getElementById('log').innerHTML = game.logs.join('<br>');
        
        const board = document.getElementById('board');
        board.innerHTML = "";
        game.players.forEach((p, i) => {
            const card = document.createElement('div');
            const isWolfTeammate = (me.role === "ç‹¼äºº" && p.role === "ç‹¼äºº");
            card.className = `card ${p.isAlive?'':'dead'} ${i===myIdx?'my-card':''}`;
            const canSee = (i===myIdx || !p.isAlive || isWolfTeammate);
            card.innerHTML = `<b>${i+1}.${p.name}</b><br>${canSee ? p.role : '???'}`;
            
            if(p.isAlive && me.isAlive) {
                if(game.phase === "NIGHT") {
                    if(me.role === "ç‹¼äºº" && i!==myIdx) card.innerHTML += `<button class="btn-act" onclick="doAct(${i},'KILL')">æ®ºæ­»</button>`;
                    if(me.role === "é è¨€å®¶" && i!==myIdx) card.innerHTML += `<button class="btn-act" style="background:#0288d1" onclick="doAct(${i},'CHECK')">é©—è­‰</button>`;
                    if(me.role === "å¥³å·«") {
                        if(i === game.victim && !game.witchHealUsed) card.innerHTML += `<button class="btn-act" style="background:#43a047" onclick="doAct(${i},'HEAL')">æ•‘äºº</button>`;
                        if(i !== myIdx && !game.witchPoisonUsed) card.innerHTML += `<button class="btn-act" style="background:#6a1b9a" onclick="doAct(${i},'POISON')">æ¯’æ®º</button>`;
                    }
                } else if(game.phase === "VOTE" && i!==myIdx) {
                    card.innerHTML += `<button class="btn-act" style="background:#fb8c00" onclick="doAct(${i},'VOTE')">æŠ•ç¥¨</button>`;
                }
            }
            board.appendChild(card);
        });
        if(isHost) document.getElementById('next-btn').style.display = "inline-block";
    }

    function doAct(target, type) {
        if(isHost) processAction(target, myIdx, type);
        else myConn.send({ type: "ACTION", target: target, fromIdx: myIdx, subType: type });
    }

    function processAction(targetIdx, fromIdx, type) {
        if(!isHost) return;
        const p = game.players[targetIdx];
        const sender = game.players[fromIdx];

        if(type === "KILL") { game.victim = targetIdx; addLog("ç‹¼äººå·²è¡Œå‹•ã€‚"); }
        else if(type === "CHECK") {
            const msg = `é©—è­‰çµæœï¼š${targetIdx+1}è™Ÿ æ˜¯ ${p.role==='ç‹¼äºº'?'ç‹¼äºº':'å¥½äºº'}`;
            if(fromIdx === 0) alert(msg);
            else conns[fromIdx-1].send({ type: "CHECK_RESULT", msg: msg });
            addLog("é è¨€å®¶å·²è¡Œå‹•ã€‚");
        }
        else if(type === "HEAL") { game.victim = null; game.witchHealUsed = true; addLog("å¥³å·«ä½¿ç”¨äº†è—¥æ°´ã€‚"); }
        else if(type === "POISON") { p.isAlive = false; game.witchPoisonUsed = true; addLog(`${targetIdx+1}è™Ÿ è¢«æ¯’æ­»äº†ã€‚`); }
        else if(type === "VOTE") { p.isAlive = false; addLog(`${targetIdx+1}è™Ÿ è¢«æŠ•ç¥¨è™•æ±ºã€‚`); game.phase = "NIGHT"; game.victim = null; }

        broadcastSync();
        checkWin();
    }

    function processAI() {
        if(!isHost || game.phase !== "NIGHT") return;
        let humanWolf = game.players.find(p => p.isAlive && !p.isAI && p.role === "ç‹¼äºº");
        if(!humanWolf) {
            let aiWolf = game.players.find(p => p.isAlive && p.isAI && p.role === "ç‹¼äºº");
            if(aiWolf) {
                let targets = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº");
                if(targets.length > 0) processAction(targets[Math.floor(Math.random()*targets.length)].id, aiWolf.id, "KILL");
            }
        }
    }

    function forceNext() {
        if(game.phase === "NIGHT") {
            if(game.victim !== null) { game.players[game.victim].isAlive = false; addLog(`${game.victim+1}è™Ÿ æ˜¨æ™šæ­»äº†ã€‚`); }
            else { addLog("æ˜¨æ™šæ˜¯å¹³å®‰å¤œã€‚"); }
            game.phase = "VOTE";
        } else { game.phase = "NIGHT"; game.victim = null; }
        broadcastSync();
        if(game.phase === "NIGHT") setTimeout(processAI, 1000);
    }

    function checkWin() {
        const wolf = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const human = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if(wolf === 0) { alert("å¥½äººå‹åˆ©ï¼"); location.reload(); }
        else if(wolf >= human) { alert("ç‹¼äººå‹åˆ©ï¼"); location.reload(); }
    }
</script>
</body>
</html>
