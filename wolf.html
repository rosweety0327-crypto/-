<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç‹¼äººæ®ºï¼š3-6äººæˆ°è¡“å¼·åŒ–ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { background: #0b0e14; color: #cfd8dc; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 15px; margin: 0; }
        #log { width: 95%; max-width: 650px; height: 200px; background: #000; padding: 12px; overflow-y: auto; color: #4caf50; border: 1px solid #37474f; border-radius: 8px; font-size: 13px; margin-bottom: 10px; }
        .setup-box { background: #1c2732; padding: 25px; border-radius: 12px; text-align: center; border: 2px solid #3498db; margin-top: 20px; width: 320px; }
        #board { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; width: 100%; max-width: 800px; }
        .card { background: #263238; border: 1px solid #455a64; padding: 10px; text-align: center; border-radius: 10px; font-size: 12px; position: relative; }
        .card.dead { opacity: 0.3; background: #111; border-color: #b71c1c; }
        .card.my-card { border: 2px solid #fdd835; }
        .card.teammate { border: 2px solid #e53935; }
        .btn-act { padding: 5px; cursor: pointer; background: #e53935; color: white; border: none; border-radius: 4px; margin-top: 5px; width: 100%; font-size: 11px; }
        .main-btn { padding: 12px 30px; background: #2e7d32; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 10px; }
        .chat-ui { width: 95%; max-width: 650px; display: flex; gap: 5px; margin-bottom: 15px; }
        #chat-input { flex-grow: 1; padding: 10px; border-radius: 5px; background: #1c2732; color: white; border: 1px solid #37474f; }
        #timer { font-size: 24px; color: #ff5252; font-weight: bold; margin-bottom: 5px; }
        .config-label { display: block; margin-top: 10px; font-size: 14px; color: #90a4ae; }
    </style>
</head>
<body>

    <h2>ğŸº ç‹¼äººæ®ºï¼š3-6äººé€£ç·šç‰ˆ</h2>
    <div id="timer">å€’æ•¸ï¼š--</div>
    <div id="status" style="color:#ffa000; margin-bottom:10px;">ä½ çš„ ID: <span id="my-id">...</span></div>

    <div id="setup-ui" class="setup-box">
        <div id="host-config">
            <span class="config-label">é¸æ“‡ç¸½äººæ•¸ (å«AI)</span>
            <select id="player-count" style="padding: 5px; width: 100px;">
                <option value="3">3 äººå±€</option>
                <option value="4">4 äººå±€</option>
                <option value="5">5 äººå±€</option>
                <option value="6" selected>6 äººå±€</option>
            </select>
            <p style="font-size: 12px; color: #888;">åˆ†äº« ID çµ¦æœ‹å‹ï¼Œé€£ç·šå¾ŒæŒ‰é–‹å§‹</p>
            <div id="connected-list" style="margin: 10px 0; font-size: 14px; color: #4caf50;">ç­‰å¾…æœ‹å‹é€£ç·š... (0)</div>
        </div>
        <hr style="border: 0.5px solid #333; margin: 15px 0;">
        <input type="text" id="join-id" placeholder="è¼¸å…¥æˆ¿ä¸» ID" style="padding:10px; width: 120px; text-align: center;">
        <button onclick="connectToFriend()">é€£ç·šæˆ¿é–“</button>
    </div>

    <div id="game-ui" style="display:none; width:100%; text-align:center;">
        <h3 id="role-display">æ­£åœ¨é€£ç·š...</h3>
        <div id="log">>> ç³»çµ±ï¼šæº–å‚™å°±ç·’ã€‚</div>
        <div class="chat-ui">
            <input type="text" id="chat-input" placeholder="å°è©±æˆ–ç§èŠ..." onkeypress="if(event.key==='Enter') sendChat()">
            <button onclick="sendChat()">å‚³é€</button>
        </div>
        <div id="board"></div>
        <button id="next-btn" class="main-btn" style="display:none;" onclick="hostCycle()">é–‹å§‹éŠæˆ²</button>
    </div>

<script>
    const shortId = Math.floor(1000 + Math.random() * 9000).toString();
    const peer = new Peer(shortId);
    let conns = []; // æˆ¿ä¸»ç”¨çš„å¤šé‡é€£ç·šé™£åˆ—
    let myConn;    // æœ‹å‹ç”¨ä¾†é€£å›æˆ¿ä¸»çš„å–®ä¸€é€£ç·š
    let isHost = false;
    let myName = "";
    let myIdx = -1;
    let timerInterval;

    let game = { 
        players: [], phase: "WAITING", logs: [],
        nightActions: { wolf: false, victim: null, seer: false, witch: false },
        votes: {}, countdown: 0, totalPlayers: 6
    };

    peer.on('open', id => { document.getElementById('my-id').innerText = id; });

    // æˆ¿ä¸»ç›£è½é€£ç·š
    peer.on('connection', c => {
        isHost = true;
        conns.push(c);
        myName = "ç©å®¶ 1 (æˆ¿ä¸»)";
        myIdx = 0;
        document.getElementById('next-btn').style.display = "inline-block";
        document.getElementById('connected-list').innerText = `å·²é€£ç·šæœ‹å‹: ${conns.length}`;
        setupHostListener(c);
        addLog(`ç©å®¶ ${conns.length + 1} å·²åŠ å…¥æˆ¿é–“`);
    });

    function connectToFriend() {
        const id = document.getElementById('join-id').value;
        myConn = peer.connect(id);
        isHost = false;
        myIdx = -1; // ç­‰å¾…æˆ¿ä¸»åˆ†é…
        setupClientListener(myConn);
        document.getElementById('setup-ui').style.display = "none";
        document.getElementById('game-ui').style.display = "block";
        document.getElementById('role-display').innerText = "å·²é€£ç·šï¼Œç­‰å¾…æˆ¿ä¸»ç™¼ç‰Œ...";
    }

    function setupHostListener(c) {
        c.on('data', data => {
            if (data.type === "CHAT") broadcastChat(data.sender, data.msg);
            else if (data.type === "ACTION") handleAction(data.target, data.fromIdx, data.subType);
        });
    }

    function setupClientListener(c) {
        c.on('data', data => {
            if (data.type === "SYNC") {
                game = data.game;
                myIdx = data.assignedIdx;
                myName = game.players[myIdx].name;
                updateUI();
            } else if (data.type === "CHAT") {
                addLog(`ğŸ’¬ ${data.sender}: ${data.msg}`);
            }
        });
    }

    function addLog(m) {
        const msg = `> ${m}`;
        game.logs.push(msg);
        if (game.logs.length > 50) game.logs.shift();
        updateUI();
    }

    function broadcastChat(sender, msg) {
        addLog(`ğŸ’¬ ${sender}: ${msg}`);
        const packet = { type: "CHAT", sender: sender, msg: msg };
        conns.forEach(c => c.send(packet));
    }

    function sendChat() {
        const input = document.getElementById('chat-input');
        const msg = input.value.trim();
        if (!msg) return;
        if (isHost) broadcastChat(myName, msg);
        else myConn.send({ type: "CHAT", sender: myName, msg: msg });
        input.value = "";
    }

    function sync() {
        if (!isHost) return;
        conns.forEach((c, index) => {
            c.send({ type: "SYNC", game: game, assignedIdx: index + 1 });
        });
        updateUI();
    }

    function hostCycle() {
        if (!isHost) return;
        if (game.phase === "WAITING") {
            const count = parseInt(document.getElementById('player-count').value);
            game.totalPlayers = count;
            
            // è§’è‰²åˆ†é…é‚è¼¯ï¼š3äºº(1ç‹¼1é 1æ°‘), 4äºº(1ç‹¼1é 1å·«1æ°‘), 5-6äºº(2ç‹¼1é 1å·«...)
            let roles = [];
            if(count == 3) roles = ["ç‹¼äºº","é è¨€å®¶","æ‘æ°‘"];
            else if(count == 4) roles = ["ç‹¼äºº","é è¨€å®¶","å¥³å·«","æ‘æ°‘"];
            else if(count == 5) roles = ["ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","æ‘æ°‘"];
            else roles = ["ç‹¼äºº","ç‹¼äºº","é è¨€å®¶","å¥³å·«","çµäºº","æ‘æ°‘"];
            
            roles = roles.sort(() => Math.random() - 0.5);
            game.players = [];
            for(let i=0; i<count; i++) {
                let pName = "";
                if(i === 0) pName = "ç©å®¶ 1 (æˆ¿ä¸»)";
                else if(i <= conns.length) pName = `ç©å®¶ ${i+1}`;
                else pName = `AI-${i+1} (è£œä½)`;
                
                game.players.push({ id: i, name: pName, role: roles[i], isAlive: true, isAI: i > conns.length });
            }
            document.getElementById('setup-ui').style.display = "none";
            document.getElementById('game-ui').style.display = "block";
            startNight();
        } else if (game.phase === "MORNING") {
            game.phase = "VOTE";
            game.votes = {};
            addLog("âš–ï¸ é€²å…¥æŠ•ç¥¨è¨è«–éšæ®µ");
            startTimer(30);
        } else if (game.phase === "VOTE_DONE") {
            startNight();
        }
        sync();
    }

    function startNight() {
        game.phase = "NIGHT";
        game.nightActions = { wolf: false, victim: null, seer: false, witch: false };
        addLog("ğŸŒ™ å¤©é»‘è«‹é–‰çœ¼...");
        startTimer(30);
        // AI é‚è¼¯æš«ç•¥ï¼Œå¯åƒè€ƒåŸç¨‹å¼
    }

    function handleAction(targetIdx, fromIdx, subType) {
        if (!isHost) return;
        if (subType === "VOTE") {
            game.votes[fromIdx] = targetIdx;
            addLog(`âœ… ${game.players[fromIdx].name} å·²æŠ•ç¥¨ã€‚`);
            checkVoteEnd();
        } else if (subType === "KILL") {
            game.nightActions.victim = targetIdx;
            game.nightActions.wolf = true;
            addLog("ğŸº ç‹¼äººå·²é¸å®šç›®æ¨™ã€‚");
        } else if (subType === "CHECK") {
            game.nightActions.seer = true;
            const res = game.players[targetIdx].role === "ç‹¼äºº" ? "ç‹¼äºº" : "å¥½äºº";
            const msg = `æŸ¥é©—çµæœï¼š${game.players[targetIdx].name} æ˜¯ ${res}`;
            if (fromIdx === 0) alert(msg);
            else conns[fromIdx-1].send({ type: "CHAT", sender: "ç³»çµ±ç§è¨Š", msg: msg });
        }
        sync();
    }

    function checkVoteEnd() {
        const aliveCount = game.players.filter(p => p.isAlive).length;
        if (Object.keys(game.votes).length >= aliveCount) {
            const tally = {};
            Object.values(game.votes).forEach(v => tally[v] = (tally[v] || 0) + 1);
            let max = 0, loser = -1;
            for (let p in tally) { if (tally[p] > max) { max = tally[p]; loser = p; } }
            if (loser != -1) processDeath(loser, "æŠ•ç¥¨æ·˜æ±°");
            game.phase = "VOTE_DONE";
            sync();
        }
    }

    function processDeath(idx, reason) {
        game.players[idx].isAlive = false;
        addLog(`ğŸ’€ ${game.players[idx].name} æ­»äº¡ (${reason})`);
        checkWin();
    }

    function checkWin() {
        const w = game.players.filter(p => p.isAlive && p.role === "ç‹¼äºº").length;
        const h = game.players.filter(p => p.isAlive && p.role !== "ç‹¼äºº").length;
        if (w === 0) { alert("å¥½äººå‹åˆ©ï¼"); location.reload(); }
        else if (w >= h) { alert("ç‹¼äººå‹åˆ©ï¼"); location.reload(); }
    }

    function startTimer(s) {
        clearInterval(timerInterval);
        game.countdown = s;
        timerInterval = setInterval(() => {
            game.countdown--;
            if (game.countdown <= 0) {
                clearInterval(timerInterval);
                if (isHost && game.phase === "NIGHT") endNight();
            }
            updateUI();
        }, 1000);
    }

    function endNight() {
        if (game.nightActions.victim !== null) processDeath(game.nightActions.victim, "ç‹¼äººæ®ºå®³");
        game.phase = "MORNING";
        addLog("â˜€ï¸ å¤©äº®äº†ï¼");
        sync();
    }

    function updateUI() {
        if (myIdx === -1) return;
        const me = game.players[myIdx];
        document.getElementById('timer').innerText = `å€’æ•¸ï¼š${game.countdown}`;
        document.getElementById('role-display').innerText = `æˆ‘çš„èº«ä»½ï¼šã€${me.role}ã€‘ (${me.isAlive ? 'å­˜æ´»' : 'æ­»äº¡'})`;
        
        const board = document.getElementById('board');
        board.innerHTML = "";
        game.players.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = `card ${p.isAlive ? '' : 'dead'} ${i === myIdx ? 'my-card' : ''}`;
            const showRole = (i === myIdx || !p.isAlive || (me.role === "ç‹¼äºº" && p.role === "ç‹¼äºº"));
            div.innerHTML = `<b>${p.name}</b><br>${showRole ? p.role : '???'}`;

            if (p.isAlive && me.isAlive && i !== myIdx) {
                if (game.phase === "VOTE" && game.votes[myIdx] === undefined) 
                    div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, 'VOTE')">æŠ•ç¥¨</button>`;
                if (game.phase === "NIGHT") {
                    if (me.role === "ç‹¼äºº" && !game.nightActions.wolf) div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, 'KILL')">æ“Šæ®º</button>`;
                    if (me.role === "é è¨€å®¶" && !game.nightActions.seer) div.innerHTML += `<button class="btn-act" onclick="userClick(${i}, 'CHECK')">é©—äºº</button>`;
                }
            }
            board.appendChild(div);
        });
        const l = document.getElementById('log');
        l.innerHTML = game.logs.join('<br>');
        l.scrollTop = l.scrollHeight;
    }

    function userClick(idx, type) {
        if (isHost) handleAction(idx, 0, type);
        else myConn.send({ type: "ACTION", target: idx, fromIdx: myIdx, subType: type });
    }
</script>
</body>
</html>
